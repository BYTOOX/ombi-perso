<!DOCTYPE html>
<html lang="fr" data-bs-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administration - Plex Kiosk</title>
    <meta name="description" content="Tableau de bord d'administration Plex Kiosk">

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --bg-dark: #0a0a0f;
            --bg-card: rgba(20, 20, 35, 0.95);
            --primary: #8b5cf6;
            --primary-glow: rgba(139, 92, 246, 0.4);
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --text-primary: #ffffff;
            --text-secondary: #a1a1aa;
            --text-muted: #71717a;
            --border-color: rgba(255, 255, 255, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0a0a0f 0%, #050508 100%);
            color: #ffffff;
            min-height: 100vh;
        }

        /* Navbar */
        .navbar-admin {
            background: rgba(10, 10, 15, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-color);
            padding: 16px 24px;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .navbar-brand-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary), #6366f1);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary), #6366f1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            cursor: pointer;
        }

        /* Main Content */
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 32px 24px;
        }

        /* Page Header */
        .page-header {
            margin-bottom: 32px;
        }

        .page-header h1 {
            font-size: 1.75rem;
            font-weight: 700;
            color: #fff;
            margin-bottom: 8px;
        }

        .page-header p {
            color: var(--text-muted);
            margin: 0;
        }

        /* Stat Cards */
        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
            display: flex;
            align-items: center;
            gap: 20px;
            height: 100%;
        }

        .stat-icon {
            width: 56px;
            height: 56px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            flex-shrink: 0;
        }

        .stat-icon.primary {
            background: rgba(139, 92, 246, 0.2);
            color: var(--primary);
        }

        .stat-icon.success {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
        }

        .stat-icon.warning {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
        }

        .stat-icon.info {
            background: rgba(59, 130, 246, 0.2);
            color: var(--info);
        }

        .stat-info h3 {
            font-size: 2rem;
            font-weight: 700;
            color: #fff;
            margin: 0 0 4px 0;
            line-height: 1;
        }

        .stat-info p {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin: 0;
        }

        /* Admin Cards */
        .admin-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
            height: 100%;
        }

        .admin-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .admin-card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 0;
        }

        .admin-card-title i {
            color: var(--primary);
        }

        /* Health Indicators */
        .health-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
            color: #fff;
        }

        .health-row:last-child {
            border-bottom: none;
        }

        .health-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .health-indicator.healthy {
            background: var(--success);
            box-shadow: 0 0 10px var(--success);
        }

        .health-indicator.unhealthy {
            background: var(--danger);
            box-shadow: 0 0 10px var(--danger);
        }

        /* Health Dots for Services */
        .health-dot {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--text-muted);
        }

        .health-dot.ok {
            background: var(--success);
            box-shadow: 0 0 8px var(--success);
        }

        .health-dot.error {
            background: var(--danger);
            box-shadow: 0 0 8px var(--danger);
        }

        .health-dot.timeout {
            background: var(--warning);
            box-shadow: 0 0 8px var(--warning);
        }

        .health-dot.not_configured {
            background: var(--text-muted);
        }

        .health-dot.disabled {
            background: var(--text-muted);
            opacity: 0.5;
        }

        /* Service Health Cards */
        .service-health-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            min-width: 140px;
            text-align: center;
        }

        .service-health-card .service-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .service-health-card .service-name {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .service-health-card .service-status {
            font-size: 12px;
            color: var(--text-muted);
        }

        .service-health-card.ok {
            border-color: var(--success);
        }

        .service-health-card.error {
            border-color: var(--danger);
        }

        /* Pending User Card */
        .pending-user-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 12px;
        }

        .pending-user-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), #6366f1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            flex-shrink: 0;
        }

        .pending-user-info {
            flex-grow: 1;
        }

        .pending-user-info strong {
            color: #fff;
            display: block;
        }

        .pending-user-info small {
            color: var(--text-muted);
        }

        /* Nav Tabs */
        .nav-tabs-custom {
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 24px;
        }

        .nav-tabs-custom .nav-link {
            border: none;
            padding: 12px 24px;
            color: var(--text-muted);
            font-weight: 500;
            background: transparent;
        }

        .nav-tabs-custom .nav-link:hover {
            color: #fff;
        }

        .nav-tabs-custom .nav-link.active {
            color: var(--primary);
            background: transparent;
            border-bottom: 2px solid var(--primary);
        }

        /* Tables */
        .table-dark-custom {
            background: transparent;
            color: #fff;
        }

        .table-dark-custom th {
            background: rgba(255, 255, 255, 0.03);
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border-color);
            padding: 14px 16px;
        }

        .table-dark-custom td {
            color: #fff;
            border-bottom: 1px solid var(--border-color);
            padding: 16px;
            vertical-align: middle;
        }

        .table-dark-custom tbody tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        /* Status Badges */
        .status-badge {
            display: inline-flex;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-badge.active {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .status-badge.pending {
            background: rgba(234, 179, 8, 0.2);
            color: #eab308;
        }

        .status-badge.disabled {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        /* Buttons */
        .btn-primary-custom {
            background: linear-gradient(135deg, var(--primary), #7c3aed);
            border: none;
            color: white;
        }

        .btn-primary-custom:hover {
            background: linear-gradient(135deg, #a78bfa, var(--primary));
            color: white;
        }

        /* Modal */
        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            color: #fff;
        }

        .modal-header {
            border-bottom: 1px solid var(--border-color);
        }

        .modal-footer {
            border-top: 1px solid var(--border-color);
        }

        .form-control,
        .form-select {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            color: #fff;
        }

        .form-control:focus,
        .form-select:focus {
            background: rgba(255, 255, 255, 0.08);
            border-color: var(--primary);
            color: #fff;
            box-shadow: 0 0 0 3px var(--primary-glow);
        }

        .form-label {
            color: var(--text-secondary);
        }

        .form-text {
            color: var(--text-muted);
        }

        .form-select option {
            background: #1a1a2e;
            color: #fff;
        }

        /* Toasts */
        .toast-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 9999;
        }

        /* Config Display */
        .config-section h5 {
            color: #fff;
            margin-bottom: 16px;
        }

        .config-section h5 i {
            color: var(--primary);
        }

        .config-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .config-list li {
            padding: 8px 0;
            color: var(--text-secondary);
        }

        .config-list li strong {
            color: #fff;
        }
    </style>
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar-admin">
        <div class="d-flex align-items-center justify-content-between">
            <a href="/" class="d-flex align-items-center gap-3 text-decoration-none">
                <div class="navbar-brand-icon">
                    <i class="bi bi-film"></i>
                </div>
                <span class="text-white fw-bold fs-5 d-none d-md-inline">Plex Kiosk</span>
            </a>
            <div class="d-flex align-items-center gap-3">
                <a href="/" class="btn btn-outline-light btn-sm">
                    <i class="bi bi-arrow-left me-2"></i>Retour
                </a>
                <div class="dropdown">
                    <div class="user-avatar" id="userAvatar" data-bs-toggle="dropdown">A</div>
                    <ul class="dropdown-menu dropdown-menu-end dropdown-menu-dark">
                        <li><a class="dropdown-item text-danger" href="#" onclick="logout()">
                                <i class="bi bi-box-arrow-right me-2"></i>Déconnexion
                            </a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-container">
        <!-- Page Header -->
        <div class="page-header d-flex justify-content-between align-items-start flex-wrap gap-3">
            <div>
                <h1><i class="bi bi-speedometer2 me-2" style="color: var(--primary)"></i>Dashboard Admin</h1>
                <p>Gérez les utilisateurs, demandes et paramètres système</p>
            </div>
            <button class="btn btn-primary-custom" onclick="refreshAll()">
                <i class="bi bi-arrow-clockwise me-2"></i>Actualiser
            </button>
        </div>

        <!-- Tabs -->
        <ul class="nav nav-tabs-custom" id="adminTabs">
            <li class="nav-item">
                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#dashboardTab">
                    <i class="bi bi-speedometer2 me-2"></i>Dashboard
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#usersTab">
                    <i class="bi bi-people me-2"></i>Utilisateurs
                    <span class="badge bg-warning ms-1" id="pendingUsersBadge" style="display:none;">0</span>
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#requestsTab">
                    <i class="bi bi-list-check me-2"></i>Demandes
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#configTab">
                    <i class="bi bi-gear me-2"></i>Configuration
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#servicesTab">
                    <i class="bi bi-plug me-2"></i>Services
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#monitoringTab">
                    <i class="bi bi-tv me-2"></i>Monitoring
                    <span class="badge bg-info ms-1" id="pendingApprovalsBadge" style="display:none;">0</span>
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#analysisTab">
                    <i class="bi bi-graph-up me-2"></i>Analyse
                    <span class="badge bg-warning ms-1" id="analysisIssuesBadge" style="display:none;">0</span>
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#mediaPathsTab">
                    <i class="bi bi-folder me-2"></i>Médias
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#renameTab">
                    <i class="bi bi-file-earmark-text me-2"></i>Renommage
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#transfersTab">
                    <i class="bi bi-arrow-left-right me-2"></i>Transferts
                    <span class="badge bg-warning ms-1" id="transfersInProgressBadge" style="display:none;">0</span>
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#logsTab">
                    <i class="bi bi-terminal me-2"></i>Logs
                    <span class="badge bg-danger ms-1" id="logsErrorBadge" style="display:none;">0</span>
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content">
            <!-- Dashboard Tab -->
            <div class="tab-pane fade show active" id="dashboardTab">
                <!-- Stats Row -->
                <div class="row g-4 mb-4">
                    <div class="col-md-6 col-lg-3">
                        <div class="stat-card">
                            <div class="stat-icon primary"><i class="bi bi-people"></i></div>
                            <div class="stat-info">
                                <h3 id="totalUsers">0</h3>
                                <p>Utilisateurs</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-3">
                        <div class="stat-card">
                            <div class="stat-icon warning"><i class="bi bi-person-plus"></i></div>
                            <div class="stat-info">
                                <h3 id="pendingUsersCount">0</h3>
                                <p>En attente</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-3">
                        <div class="stat-card">
                            <div class="stat-icon info"><i class="bi bi-hourglass-split"></i></div>
                            <div class="stat-info">
                                <h3 id="pendingRequests">0</h3>
                                <p>Demandes</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-3">
                        <div class="stat-card">
                            <div class="stat-icon success"><i class="bi bi-check-circle"></i></div>
                            <div class="stat-info">
                                <h3 id="completedToday">0</h3>
                                <p>Terminées</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Health & Pending Row -->
                <div class="row g-4">
                    <div class="col-lg-6">
                        <div class="admin-card">
                            <div class="admin-card-header">
                                <h3 class="admin-card-title"><i class="bi bi-heart-pulse"></i>État du Système</h3>
                            </div>
                            <div id="healthChecks">
                                <div class="health-row">
                                    <span><i class="bi bi-database me-2"></i>Base de données</span>
                                    <span class="health-indicator healthy"></span>
                                </div>
                                <div class="health-row">
                                    <span><i class="bi bi-download me-2"></i>qBittorrent</span>
                                    <span class="health-indicator" id="qbitHealth"></span>
                                </div>
                                <div class="health-row">
                                    <span><i class="bi bi-play-circle me-2"></i>Plex</span>
                                    <span class="health-indicator" id="plexHealth"></span>
                                </div>
                                <div class="health-row">
                                    <span><i class="bi bi-robot me-2"></i>Ollama AI</span>
                                    <span class="health-indicator" id="ollamaHealth"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="admin-card">
                            <div class="admin-card-header">
                                <h3 class="admin-card-title"><i class="bi bi-person-plus"></i>Utilisateurs en Attente
                                </h3>
                            </div>
                            <div id="pendingUsersQuick">
                                <div class="text-center py-4 text-muted">
                                    <i class="bi bi-check-circle fs-1 mb-2 d-block"></i>
                                    Aucun utilisateur en attente
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Users Tab -->
            <div class="tab-pane fade" id="usersTab">
                <!-- Pending Section -->
                <div class="admin-card mb-4" id="pendingUsersSection" style="display:none;">
                    <div class="admin-card-header">
                        <h3 class="admin-card-title"><i class="bi bi-person-plus" style="color:var(--warning)"></i>En
                            attente d'approbation</h3>
                    </div>
                    <div id="pendingUsersList"></div>
                </div>

                <!-- All Users -->
                <div class="admin-card">
                    <div class="admin-card-header">
                        <h3 class="admin-card-title"><i class="bi bi-people"></i>Tous les Utilisateurs</h3>
                        <button class="btn btn-primary-custom btn-sm" onclick="showCreateUserModal()">
                            <i class="bi bi-person-plus me-1"></i>Créer
                        </button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-dark-custom">
                            <thead>
                                <tr>
                                    <th>Utilisateur</th>
                                    <th>Email</th>
                                    <th>Rôle</th>
                                    <th>Statut</th>
                                    <th>Demandes</th>
                                    <th>Créé le</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersBody">
                                <tr>
                                    <td colspan="7" class="text-center py-4">
                                        <div class="spinner-border spinner-border-sm text-primary"></div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Requests Tab -->
            <div class="tab-pane fade" id="requestsTab">
                <div class="admin-card">
                    <div class="admin-card-header">
                        <h3 class="admin-card-title"><i class="bi bi-list-check"></i>Toutes les Demandes</h3>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-dark-custom">
                            <thead>
                                <tr>
                                    <th>Média</th>
                                    <th>Utilisateur</th>
                                    <th>Statut</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="requestsBody">
                                <tr>
                                    <td colspan="5" class="text-center py-4">
                                        <div class="spinner-border spinner-border-sm text-primary"></div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Config Tab -->
            <div class="tab-pane fade" id="configTab">
                <div class="admin-card">
                    <div class="admin-card-header">
                        <h3 class="admin-card-title"><i class="bi bi-gear"></i>Configuration Actuelle</h3>
                    </div>
                    <div id="configDisplay">
                        <div class="text-center py-4">
                            <div class="spinner-border spinner-border-sm text-primary"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Services Tab -->
            <div class="tab-pane fade" id="servicesTab">
                <div class="row g-4 mb-4">
                    <!-- Services Health Summary -->
                    <div class="col-12">
                        <div class="admin-card">
                            <div class="admin-card-header">
                                <h3 class="admin-card-title"><i class="bi bi-heart-pulse"></i>État des Services</h3>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-outline-primary" onclick="refreshAllServicesHealth()">
                                        <i class="bi bi-arrow-clockwise me-1"></i>Actualiser
                                    </button>
                                    <button class="btn btn-sm btn-outline-warning" onclick="migrateServicesFromEnv()">
                                        <i class="bi bi-box-arrow-in-down me-1"></i>Migrer depuis .env
                                    </button>
                                </div>
                            </div>
                            <div id="servicesHealthSummary" class="p-3">
                                <div class="d-flex flex-wrap gap-3" id="servicesHealthCards">
                                    <div class="text-center py-3 w-100">
                                        <div class="spinner-border spinner-border-sm text-primary"></div>
                                        <span class="ms-2 text-muted">Chargement...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Services Configuration Grid -->
                <div class="row g-4" id="servicesConfigGrid">
                    <!-- Plex Card -->
                    <div class="col-lg-6" data-service="plex">
                        <div class="admin-card h-100">
                            <div class="admin-card-header">
                                <h3 class="admin-card-title">
                                    <i class="bi bi-play-circle me-2"></i>Plex Media Server
                                    <span class="health-dot ms-2" id="plex-health-dot"></span>
                                </h3>
                                <button class="btn btn-sm btn-outline-primary" onclick="testServiceConnection('plex')">
                                    <i class="bi bi-broadcast me-1"></i>Tester
                                </button>
                            </div>
                            <div class="p-3">
                                <p class="text-muted small mb-3">Serveur de médias pour la bibliothèque</p>
                                <div class="mb-3">
                                    <label class="form-label small">URL du serveur</label>
                                    <input type="text" class="form-control form-control-sm" id="plex-url"
                                           placeholder="http://192.168.1.x:32400">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label small">Token</label>
                                    <div class="input-group input-group-sm">
                                        <input type="password" class="form-control" id="plex-token" placeholder="X-Plex-Token">
                                        <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('plex-token')">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="plex-enabled" checked>
                                    <label class="form-check-label small" for="plex-enabled">Service activé</label>
                                </div>
                                <div class="mt-2 small" id="plex-status"></div>
                            </div>
                        </div>
                    </div>

                    <!-- qBittorrent Card -->
                    <div class="col-lg-6" data-service="qbittorrent">
                        <div class="admin-card h-100">
                            <div class="admin-card-header">
                                <h3 class="admin-card-title">
                                    <i class="bi bi-download me-2"></i>qBittorrent
                                    <span class="health-dot ms-2" id="qbittorrent-health-dot"></span>
                                </h3>
                                <button class="btn btn-sm btn-outline-primary" onclick="testServiceConnection('qbittorrent')">
                                    <i class="bi bi-broadcast me-1"></i>Tester
                                </button>
                            </div>
                            <div class="p-3">
                                <p class="text-muted small mb-3">Client de téléchargement BitTorrent</p>
                                <div class="mb-3">
                                    <label class="form-label small">URL WebUI</label>
                                    <input type="text" class="form-control form-control-sm" id="qbittorrent-url"
                                           placeholder="http://localhost:8080">
                                </div>
                                <div class="row g-2 mb-3">
                                    <div class="col-6">
                                        <label class="form-label small">Nom d'utilisateur</label>
                                        <input type="text" class="form-control form-control-sm" id="qbittorrent-username"
                                               placeholder="admin">
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label small">Mot de passe</label>
                                        <div class="input-group input-group-sm">
                                            <input type="password" class="form-control" id="qbittorrent-password">
                                            <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('qbittorrent-password')">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="qbittorrent-enabled" checked>
                                    <label class="form-check-label small" for="qbittorrent-enabled">Service activé</label>
                                </div>
                                <div class="mt-2 small" id="qbittorrent-status"></div>
                            </div>
                        </div>
                    </div>

                    <!-- AI Card -->
                    <div class="col-lg-6" data-service="ai">
                        <div class="admin-card h-100">
                            <div class="admin-card-header">
                                <h3 class="admin-card-title">
                                    <i class="bi bi-robot me-2"></i>IA (OpenAI-compatible)
                                    <span class="health-dot ms-2" id="ai-health-dot"></span>
                                </h3>
                                <button class="btn btn-sm btn-outline-primary" onclick="testAIConnection()">
                                    <i class="bi bi-broadcast me-1"></i>Tester
                                </button>
                            </div>
                            <div class="p-3">
                                <p class="text-muted small mb-3">llama.cpp, OpenAI, OpenRouter</p>

                                <!-- Provider Type -->
                                <div class="mb-3">
                                    <label class="form-label small">Type de provider</label>
                                    <select class="form-select form-select-sm" id="ai-provider-type" onchange="updateAIUrlHint()">
                                        <option value="llama_cpp">llama.cpp / llama-cpp-python</option>
                                        <option value="openai">OpenAI</option>
                                        <option value="openrouter">OpenRouter</option>
                                    </select>
                                </div>

                                <!-- URL -->
                                <div class="mb-3">
                                    <label class="form-label small">URL du serveur</label>
                                    <input type="text" class="form-control form-control-sm" id="ai-url"
                                           placeholder="http://192.168.1.x:8080">
                                    <div class="form-text small" id="ai-url-hint">Ex: http://localhost:8080</div>
                                </div>

                                <!-- API Key (optional) -->
                                <div class="mb-3">
                                    <label class="form-label small">Clé API (optionnel)</label>
                                    <div class="input-group input-group-sm">
                                        <input type="password" class="form-control" id="ai-api-key"
                                               placeholder="sk-... ou laisser vide">
                                        <button class="btn btn-outline-secondary" type="button"
                                                onclick="togglePasswordVisibility('ai-api-key')">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                    </div>
                                </div>

                                <!-- Models Section (hidden until test) -->
                                <div id="ai-models-section" style="display: none;">
                                    <hr class="my-2">
                                    <p class="small text-muted mb-2">Modèles par usage:</p>

                                    <div class="mb-2">
                                        <label class="form-label small">Scoring torrents</label>
                                        <select class="form-select form-select-sm" id="ai-model-scoring">
                                            <option value="">-- Tester d'abord --</option>
                                        </select>
                                    </div>

                                    <div class="mb-2">
                                        <label class="form-label small">Renommage fichiers</label>
                                        <select class="form-select form-select-sm" id="ai-model-rename">
                                            <option value="">-- Tester d'abord --</option>
                                        </select>
                                    </div>

                                    <div class="mb-2">
                                        <label class="form-label small">Analyse librairie</label>
                                        <select class="form-select form-select-sm" id="ai-model-analysis">
                                            <option value="">-- Tester d'abord --</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="form-check form-switch mt-3">
                                    <input class="form-check-input" type="checkbox" id="ai-enabled" checked>
                                    <label class="form-check-label small" for="ai-enabled">Service activé</label>
                                </div>
                                <div class="mt-2 small" id="ai-status"></div>
                            </div>
                        </div>
                    </div>

                    <!-- YGGtorrent Card -->
                    <div class="col-lg-6" data-service="ygg">
                        <div class="admin-card h-100">
                            <div class="admin-card-header">
                                <h3 class="admin-card-title">
                                    <i class="bi bi-magnet me-2"></i>YGGtorrent
                                    <span class="health-dot ms-2" id="ygg-health-dot"></span>
                                </h3>
                                <button class="btn btn-sm btn-outline-primary" onclick="testServiceConnection('ygg')">
                                    <i class="bi bi-broadcast me-1"></i>Tester
                                </button>
                            </div>
                            <div class="p-3">
                                <p class="text-muted small mb-3">Source de torrents français</p>
                                <div class="mb-3">
                                    <label class="form-label small">URL de base</label>
                                    <input type="text" class="form-control form-control-sm" id="ygg-url"
                                           placeholder="https://www.yggtorrent.top">
                                </div>
                                <div class="row g-2 mb-3">
                                    <div class="col-6">
                                        <label class="form-label small">Nom d'utilisateur</label>
                                        <input type="text" class="form-control form-control-sm" id="ygg-username">
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label small">Mot de passe</label>
                                        <div class="input-group input-group-sm">
                                            <input type="password" class="form-control" id="ygg-password">
                                            <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('ygg-password')">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label small">Passkey (optionnel)</label>
                                    <div class="input-group input-group-sm">
                                        <input type="password" class="form-control" id="ygg-passkey"
                                               placeholder="Pour téléchargements directs">
                                        <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('ygg-passkey')">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="ygg-enabled" checked>
                                    <label class="form-check-label small" for="ygg-enabled">Service activé</label>
                                </div>
                                <div class="mt-2 small" id="ygg-status"></div>
                            </div>
                        </div>
                    </div>

                    <!-- TMDB Card -->
                    <div class="col-lg-6" data-service="tmdb">
                        <div class="admin-card h-100">
                            <div class="admin-card-header">
                                <h3 class="admin-card-title">
                                    <i class="bi bi-film me-2"></i>TMDB
                                    <span class="health-dot ms-2" id="tmdb-health-dot"></span>
                                </h3>
                                <button class="btn btn-sm btn-outline-primary" onclick="testServiceConnection('tmdb')">
                                    <i class="bi bi-broadcast me-1"></i>Tester
                                </button>
                            </div>
                            <div class="p-3">
                                <p class="text-muted small mb-3">Base de données de films et séries</p>
                                <div class="mb-3">
                                    <label class="form-label small">Clé API</label>
                                    <div class="input-group input-group-sm">
                                        <input type="password" class="form-control" id="tmdb-api-key"
                                               placeholder="Clé API TMDB v3">
                                        <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('tmdb-api-key')">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="tmdb-enabled" checked>
                                    <label class="form-check-label small" for="tmdb-enabled">Service activé</label>
                                </div>
                                <div class="mt-2 small" id="tmdb-status"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Discord Card -->
                    <div class="col-lg-6" data-service="discord">
                        <div class="admin-card h-100">
                            <div class="admin-card-header">
                                <h3 class="admin-card-title">
                                    <i class="bi bi-discord me-2"></i>Discord
                                    <span class="health-dot ms-2" id="discord-health-dot"></span>
                                </h3>
                                <button class="btn btn-sm btn-outline-primary" onclick="testServiceConnection('discord')">
                                    <i class="bi bi-broadcast me-1"></i>Tester
                                </button>
                            </div>
                            <div class="p-3">
                                <p class="text-muted small mb-3">Notifications via webhook</p>
                                <div class="mb-3">
                                    <label class="form-label small">URL du Webhook</label>
                                    <div class="input-group input-group-sm">
                                        <input type="password" class="form-control" id="discord-url"
                                               placeholder="https://discord.com/api/webhooks/...">
                                        <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('discord-url')">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="discord-enabled" checked>
                                    <label class="form-check-label small" for="discord-enabled">Service activé</label>
                                </div>
                                <div class="mt-2 small" id="discord-status"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Save All Button -->
                <div class="row mt-4">
                    <div class="col-12 text-end">
                        <button class="btn btn-primary-custom btn-lg" onclick="saveAllServicesConfig()">
                            <i class="bi bi-check-lg me-2"></i>Enregistrer tous les services
                        </button>
                    </div>
                </div>
            </div>

            <!-- Monitoring Tab -->
            <div class="tab-pane fade" id="monitoringTab">
                <!-- Stats Row -->
                <div class="row g-4 mb-4">
                    <div class="col-md-6 col-lg-3">
                        <div class="stat-card">
                            <div class="stat-icon primary"><i class="bi bi-tv"></i></div>
                            <div class="stat-info">
                                <h3 id="monitoringTotalSeries">0</h3>
                                <p>Séries suivies</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-3">
                        <div class="stat-card">
                            <div class="stat-icon success"><i class="bi bi-play-circle"></i></div>
                            <div class="stat-info">
                                <h3 id="monitoringActiveSeries">0</h3>
                                <p>Actives</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-3">
                        <div class="stat-card">
                            <div class="stat-icon warning"><i class="bi bi-hourglass-split"></i></div>
                            <div class="stat-info">
                                <h3 id="monitoringPendingApprovals">0</h3>
                                <p>En attente</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-3">
                        <div class="stat-card">
                            <div class="stat-icon info"><i class="bi bi-calendar-event"></i></div>
                            <div class="stat-info">
                                <h3 id="monitoringUpcomingEpisodes">0</h3>
                                <p>Épisodes à venir</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sub-tabs -->
                <ul class="nav nav-pills mb-4" id="monitoringSubTabs">
                    <li class="nav-item">
                        <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#seriesListPane">
                            <i class="bi bi-list-ul me-1"></i>Séries suivies
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#calendarPane">
                            <i class="bi bi-calendar3 me-1"></i>Calendrier
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#pendingApprovalsPane">
                            <i class="bi bi-hourglass-split me-1"></i>En attente
                            <span class="badge bg-warning ms-1" id="pendingApprovalsPillBadge" style="display:none;">0</span>
                        </button>
                    </li>
                </ul>

                <!-- Sub-tab Content -->
                <div class="tab-content">
                    <!-- Series List Pane -->
                    <div class="tab-pane fade show active" id="seriesListPane">
                        <div class="admin-card">
                            <div class="admin-card-header">
                                <h3 class="admin-card-title"><i class="bi bi-tv"></i>Séries suivies</h3>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-outline-primary" onclick="refreshMonitoredSeries()">
                                        <i class="bi bi-arrow-clockwise me-1"></i>Actualiser
                                    </button>
                                    <button class="btn btn-sm btn-primary-custom" onclick="showAddSeriesModal()">
                                        <i class="bi bi-plus-lg me-1"></i>Ajouter
                                    </button>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-dark-custom">
                                    <thead>
                                        <tr>
                                            <th style="width:60px;"></th>
                                            <th>Titre</th>
                                            <th style="width:100px;">Type</th>
                                            <th style="width:120px;">Qualité</th>
                                            <th style="width:100px;">Audio</th>
                                            <th style="width:100px;">Statut</th>
                                            <th style="width:120px;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="monitoredSeriesBody">
                                        <tr>
                                            <td colspan="7" class="text-center py-4">
                                                <div class="spinner-border spinner-border-sm text-primary"></div>
                                                <span class="ms-2 text-muted">Chargement...</span>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Calendar Pane -->
                    <div class="tab-pane fade" id="calendarPane">
                        <div class="admin-card">
                            <div class="admin-card-header">
                                <h3 class="admin-card-title"><i class="bi bi-calendar3"></i>Calendrier des épisodes</h3>
                                <div class="d-flex gap-2 align-items-center">
                                    <select class="form-select form-select-sm" id="calendarDaysFilter" style="width:auto;">
                                        <option value="7">7 jours</option>
                                        <option value="14" selected>14 jours</option>
                                        <option value="30">30 jours</option>
                                    </select>
                                    <button class="btn btn-sm btn-outline-primary" onclick="refreshCalendar()">
                                        <i class="bi bi-arrow-clockwise me-1"></i>Actualiser
                                    </button>
                                </div>
                            </div>
                            <div id="calendarContent" class="p-3">
                                <div class="text-center py-4">
                                    <div class="spinner-border spinner-border-sm text-primary"></div>
                                    <span class="ms-2 text-muted">Chargement du calendrier...</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pending Approvals Pane -->
                    <div class="tab-pane fade" id="pendingApprovalsPane">
                        <div class="admin-card">
                            <div class="admin-card-header">
                                <h3 class="admin-card-title"><i class="bi bi-hourglass-split"></i>Épisodes en attente d'approbation</h3>
                                <button class="btn btn-sm btn-outline-primary" onclick="refreshPendingApprovals()">
                                    <i class="bi bi-arrow-clockwise me-1"></i>Actualiser
                                </button>
                            </div>
                            <div id="pendingApprovalsContent">
                                <div class="text-center py-4 text-muted">
                                    <i class="bi bi-check-circle fs-1 mb-2 d-block"></i>
                                    Aucun épisode en attente d'approbation
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Manual Tasks -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="admin-card">
                            <div class="admin-card-header">
                                <h3 class="admin-card-title"><i class="bi bi-gear"></i>Tâches manuelles</h3>
                            </div>
                            <div class="d-flex flex-wrap gap-2 p-3">
                                <button class="btn btn-outline-primary" onclick="triggerEpisodeCheck()">
                                    <i class="bi bi-search me-1"></i>Rechercher nouveaux épisodes
                                </button>
                                <button class="btn btn-outline-secondary" onclick="triggerAiredUpdate()">
                                    <i class="bi bi-calendar-check me-1"></i>Mettre à jour statuts diffusés
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analysis Tab -->
            <div class="tab-pane fade" id="analysisTab">
                <!-- Stats Row -->
                <div class="row g-4 mb-4">
                    <div class="col-md-3">
                        <div class="admin-card text-center">
                            <div class="display-4 text-danger mb-2" id="analysisHighCount">0</div>
                            <div class="text-muted">Priorité haute</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="admin-card text-center">
                            <div class="display-4 text-warning mb-2" id="analysisMediumCount">0</div>
                            <div class="text-muted">Priorité moyenne</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="admin-card text-center">
                            <div class="display-4 text-success mb-2" id="analysisLowCount">0</div>
                            <div class="text-muted">Priorité basse</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="admin-card text-center">
                            <div class="display-4 text-info mb-2" id="analysisTotalCount">0</div>
                            <div class="text-muted">Total problèmes</div>
                        </div>
                    </div>
                </div>

                <!-- Analysis Controls -->
                <div class="row g-4 mb-4">
                    <div class="col-12">
                        <div class="admin-card">
                            <h5 class="mb-3"><i class="bi bi-gear me-2"></i>Lancer une analyse</h5>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label">Types d'analyse</label>
                                    <select class="form-select" id="analysisTypes" multiple size="5">
                                        <option value="missing_collection" selected>Collections manquantes</option>
                                        <option value="low_quality" selected>Qualité basse (480p, SD)</option>
                                        <option value="bad_codec" selected>Codecs obsolètes</option>
                                        <option value="vostfr_upgradable" selected>VOSTFR upgradable</option>
                                        <option value="missing_episodes" selected>Épisodes manquants</option>
                                    </select>
                                    <small class="text-muted">Ctrl+clic pour sélection multiple</small>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Types de médias</label>
                                    <select class="form-select" id="analysisMediaTypes" multiple size="5">
                                        <option value="movie" selected>Films</option>
                                        <option value="series" selected>Séries</option>
                                        <option value="anime" selected>Animés</option>
                                    </select>
                                </div>
                                <div class="col-md-4 d-flex flex-column justify-content-end">
                                    <button class="btn btn-primary btn-lg" id="startAnalysisBtn" onclick="startAnalysis()">
                                        <i class="bi bi-play-fill me-2"></i>Lancer l'analyse
                                    </button>
                                    <div class="mt-2" id="analysisProgress" style="display:none;">
                                        <div class="progress">
                                            <div class="progress-bar progress-bar-striped progress-bar-animated"
                                                 role="progressbar" id="analysisProgressBar" style="width: 0%">0%</div>
                                        </div>
                                        <small class="text-muted" id="analysisPhase">Initialisation...</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filters -->
                <div class="row g-4 mb-4">
                    <div class="col-12">
                        <div class="admin-card">
                            <div class="d-flex flex-wrap gap-3 align-items-end">
                                <div>
                                    <label class="form-label">Type de problème</label>
                                    <select class="form-select" id="filterAnalysisType" onchange="filterAnalysisResults()">
                                        <option value="">Tous les types</option>
                                        <option value="missing_collection">Collections manquantes</option>
                                        <option value="low_quality">Qualité basse</option>
                                        <option value="bad_codec">Codecs obsolètes</option>
                                        <option value="vostfr_upgradable">VOSTFR upgradable</option>
                                        <option value="missing_episodes">Épisodes manquants</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="form-label">Sévérité</label>
                                    <select class="form-select" id="filterSeverity" onchange="filterAnalysisResults()">
                                        <option value="">Toutes</option>
                                        <option value="high">Haute</option>
                                        <option value="medium">Moyenne</option>
                                        <option value="low">Basse</option>
                                    </select>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="showDismissed" onchange="filterAnalysisResults()">
                                    <label class="form-check-label" for="showDismissed">Afficher les ignorés</label>
                                </div>
                                <button class="btn btn-outline-secondary" onclick="loadAnalysisResults()">
                                    <i class="bi bi-arrow-clockwise me-1"></i>Actualiser
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Results Table -->
                <div class="row g-4">
                    <div class="col-12">
                        <div class="admin-card">
                            <h5 class="mb-3"><i class="bi bi-list-check me-2"></i>Résultats d'analyse</h5>
                            <div class="table-responsive">
                                <table class="table table-dark table-hover" id="analysisResultsTable">
                                    <thead>
                                        <tr>
                                            <th style="width: 60px;">Poster</th>
                                            <th>Titre</th>
                                            <th>Type</th>
                                            <th>Problème</th>
                                            <th>Sévérité</th>
                                            <th>Action recommandée</th>
                                            <th style="width: 150px;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="analysisResultsBody">
                                        <tr>
                                            <td colspan="7" class="text-center text-muted py-4">
                                                <i class="bi bi-graph-up display-4"></i>
                                                <p class="mt-2 mb-0">Aucun résultat. Lancez une analyse pour détecter les problèmes.</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Analysis History -->
                <div class="row g-4 mt-2">
                    <div class="col-12">
                        <div class="admin-card">
                            <h5 class="mb-3"><i class="bi bi-clock-history me-2"></i>Historique des analyses</h5>
                            <div class="table-responsive">
                                <table class="table table-dark table-hover" id="analysisHistoryTable">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Statut</th>
                                            <th>Types analysés</th>
                                            <th>Items analysés</th>
                                            <th>Problèmes trouvés</th>
                                            <th>Durée</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="analysisHistoryBody">
                                        <tr>
                                            <td colspan="7" class="text-center text-muted py-4">
                                                Aucune analyse effectuée
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Media Paths Tab -->
            <div class="tab-pane fade" id="mediaPathsTab">
                <div class="row g-4">
                    <!-- Download Path -->
                    <div class="col-12">
                        <div class="admin-card">
                            <div class="admin-card-header">
                                <h3 class="admin-card-title"><i class="bi bi-download"></i>Dossier de Téléchargement
                                </h3>
                            </div>
                            <p class="text-muted small mb-3">Dossier temporaire où les torrents sont téléchargés avant
                                d'être déplacés vers les librairies.</p>
                            <div class="input-group">
                                <input type="text" class="form-control" id="downloadPathInput" placeholder="/downloads">
                                <button class="btn btn-outline-primary" type="button"
                                    onclick="openFileBrowser('downloadPathInput')">
                                    <i class="bi bi-folder2-open me-1"></i>Parcourir
                                </button>
                            </div>
                            <div class="mt-2" id="downloadPathStatus"></div>
                        </div>
                    </div>

                    <!-- Library Paths -->
                    <div class="col-12">
                        <div class="admin-card">
                            <div class="admin-card-header">
                                <h3 class="admin-card-title"><i class="bi bi-collection"></i>Chemins des Librairies</h3>
                            </div>
                            <p class="text-muted small mb-3">Chemins vers les dossiers Plex pour chaque type de média.
                            </p>
                            <div class="table-responsive">
                                <table class="table table-dark-custom mb-0">
                                    <thead>
                                        <tr>
                                            <th style="width:180px;">Type</th>
                                            <th>Chemin</th>
                                            <th style="width:100px;">État</th>
                                            <th style="width:80px;"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="libraryPathsBody">
                                        <tr>
                                            <td colspan="4" class="text-center py-4">
                                                <div class="spinner-border spinner-border-sm text-primary"></div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Save Button -->
                    <div class="col-12 text-end">
                        <button class="btn btn-primary-custom btn-lg" onclick="savePathSettings()">
                            <i class="bi bi-check-lg me-2"></i>Enregistrer les chemins
                        </button>
                    </div>
                </div>
            </div>

            <!-- Logs Tab -->
            <div class="tab-pane fade" id="logsTab">
                <div class="admin-card">
                    <div class="admin-card-header">
                        <h3 class="admin-card-title"><i class="bi bi-terminal"></i>Logs Système</h3>
                        <div class="d-flex align-items-center gap-2">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="logsAutoRefresh">
                                <label class="form-check-label text-muted small" for="logsAutoRefresh">Auto (5s)</label>
                            </div>
                            <button class="btn btn-sm btn-outline-light" onclick="loadLogs()">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="d-flex flex-wrap gap-2 mb-3 p-3"
                        style="background: rgba(0,0,0,0.2); border-radius: 8px;">
                        <!-- Module Pills -->
                        <div class="btn-group flex-wrap" id="logsModulePills">
                            <button class="btn btn-sm btn-primary" data-module="all">Tous</button>
                            <button class="btn btn-sm btn-outline-secondary" data-module="api">API</button>
                            <button class="btn btn-sm btn-outline-secondary" data-module="pipeline">Pipeline</button>
                            <button class="btn btn-sm btn-outline-info" data-module="ai">🤖 AI</button>
                            <button class="btn btn-sm btn-outline-secondary" data-module="services">Services</button>
                            <button class="btn btn-sm btn-outline-secondary" data-module="database">Database</button>
                        </div>

                        <!-- Level Filter -->
                        <select class="form-select form-select-sm" id="logsLevelFilter" style="width: auto;">
                            <option value="">Tous niveaux</option>
                            <option value="DEBUG">DEBUG</option>
                            <option value="INFO">INFO</option>
                            <option value="WARNING">WARNING</option>
                            <option value="ERROR">ERROR</option>
                        </select>

                        <!-- Search -->
                        <input type="search" class="form-control form-control-sm" id="logsSearch"
                            placeholder="Rechercher..." style="width: 200px;">
                    </div>

                    <!-- Stats -->
                    <div class="d-flex gap-3 mb-3 text-muted small" id="logsStats">
                        <span><i class="bi bi-info-circle text-info"></i> <span id="logsInfoCount">0</span> info</span>
                        <span><i class="bi bi-exclamation-triangle text-warning"></i> <span
                                id="logsWarningCount">0</span> warnings</span>
                        <span><i class="bi bi-x-circle text-danger"></i> <span id="logsErrorCount">0</span>
                            errors</span>
                    </div>

                    <!-- Logs Container -->
                    <div id="logsContainer"
                        style="max-height: 600px; overflow-y: auto; font-family: 'JetBrains Mono', 'Consolas', monospace; font-size: 0.8rem;">
                        <div class="text-center py-4">
                            <div class="spinner-border spinner-border-sm text-primary"></div>
                        </div>
                    </div>

                    <!-- Load More -->
                    <div class="text-center mt-3">
                        <button class="btn btn-outline-secondary btn-sm" id="logsLoadMore" onclick="loadMoreLogs()"
                            style="display:none;">
                            Charger plus...
                        </button>
                        <div class="text-muted small mt-2" id="logsPagination"></div>
                    </div>
                </div>
            </div>

            <!-- Rename Tab -->
            <div class="tab-pane fade" id="renameTab">
                <!-- Sub-tabs for media types -->
                <ul class="nav nav-pills mb-4" id="renameSubTabs">
                    <li class="nav-item">
                        <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#renameMoviesTab">
                            <i class="bi bi-film me-1"></i>Films
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#renameSeriesTab">
                            <i class="bi bi-tv me-1"></i>Séries
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#renameAnimeTab">
                            <i class="bi bi-stars me-1"></i>Animés
                        </button>
                    </li>
                </ul>

                <div class="tab-content">
                    <!-- Films Tab -->
                    <div class="tab-pane fade show active" id="renameMoviesTab">
                        <div class="row g-4">
                            <div class="col-lg-6">
                                <div class="admin-card">
                                    <div class="admin-card-header">
                                        <h3 class="admin-card-title"><i class="bi bi-film"></i>Configuration Films</h3>
                                    </div>
                                    <div class="p-3">
                                        <div class="mb-3">
                                            <label class="form-label">Priorité audio</label>
                                            <div class="p-2 rounded" style="background: rgba(0,0,0,0.2);">
                                                <span class="badge bg-success">1. Multi (avec FR)</span>
                                                <i class="bi bi-arrow-right mx-2 text-muted"></i>
                                                <span class="badge bg-primary">2. VF</span>
                                                <i class="bi bi-arrow-right mx-2 text-muted"></i>
                                                <span class="badge bg-secondary">3. VOSTFR</span>
                                            </div>
                                            <div class="form-text">Ordre de préférence des torrents</div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Sous-titres</label>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="movieSubFr" checked
                                                    disabled>
                                                <label class="form-check-label" for="movieSubFr">Français
                                                    uniquement</label>
                                            </div>
                                        </div>
                                        <hr>
                                        <div class="mb-3">
                                            <label class="form-label">Template de nommage</label>
                                            <input type="text" class="form-control font-monospace"
                                                id="renameMovieFormat" value="{title} ({year})">
                                            <div class="form-text">Variables: {title}, {year}</div>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="movieIncludeTmdb">
                                            <label class="form-check-label" for="movieIncludeTmdb">
                                                Inclure ID TMDB <code>{tmdb-xxx}</code>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div class="admin-card">
                                    <div class="admin-card-header">
                                        <h3 class="admin-card-title"><i class="bi bi-bug"></i>Tester (Film)</h3>
                                    </div>
                                    <div class="p-3">
                                        <div class="mb-3">
                                            <input type="text" class="form-control font-monospace"
                                                id="testMovieFilename"
                                                placeholder="Avatar.2009.1080p.BluRay.x264-SPARKS.mkv">
                                        </div>
                                        <button class="btn btn-primary-custom w-100" onclick="testRename('movie')">
                                            <i class="bi bi-play me-1"></i>Tester le renommage
                                        </button>
                                        <div id="movieTestResult" class="mt-3" style="display:none;">
                                            <div class="p-3 rounded" style="background: rgba(0,0,0,0.3);">
                                                <small class="text-muted">Résultat:</small>
                                                <div class="font-monospace text-success" id="movieResultRenamed"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Séries Tab -->
                    <div class="tab-pane fade" id="renameSeriesTab">
                        <div class="row g-4">
                            <div class="col-lg-6">
                                <div class="admin-card">
                                    <div class="admin-card-header">
                                        <h3 class="admin-card-title"><i class="bi bi-tv"></i>Configuration Séries</h3>
                                    </div>
                                    <div class="p-3">
                                        <div class="mb-3">
                                            <label class="form-label">Priorité audio</label>
                                            <div class="p-2 rounded" style="background: rgba(0,0,0,0.2);">
                                                <span class="badge bg-success">1. Multi (avec FR)</span>
                                                <i class="bi bi-arrow-right mx-2 text-muted"></i>
                                                <span class="badge bg-primary">2. VF</span>
                                                <i class="bi bi-arrow-right mx-2 text-muted"></i>
                                                <span class="badge bg-secondary">3. VOSTFR</span>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Sous-titres</label>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" checked disabled>
                                                <label class="form-check-label">Français uniquement</label>
                                            </div>
                                        </div>
                                        <hr>
                                        <div class="mb-3">
                                            <label class="form-label">Template de nommage</label>
                                            <textarea class="form-control font-monospace" id="renameSeriesFormat"
                                                rows="2">{title} ({year})/Season {season:02d}/{title} ({year}) - S{season:02d}E{episode:02d}</textarea>
                                            <div class="form-text">Variables: {title}, {year}, {season}, {episode}</div>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="seriesIncludeTvdb">
                                            <label class="form-check-label" for="seriesIncludeTvdb">
                                                Inclure ID TVDB <code>{tvdb-xxx}</code>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div class="admin-card">
                                    <div class="admin-card-header">
                                        <h3 class="admin-card-title"><i class="bi bi-bug"></i>Tester (Série)</h3>
                                    </div>
                                    <div class="p-3">
                                        <div class="mb-3">
                                            <input type="text" class="form-control font-monospace"
                                                id="testSeriesFilename"
                                                placeholder="Breaking.Bad.S01E01.1080p.BluRay.mkv">
                                        </div>
                                        <button class="btn btn-primary-custom w-100" onclick="testRename('series')">
                                            <i class="bi bi-play me-1"></i>Tester le renommage
                                        </button>
                                        <div id="seriesTestResult" class="mt-3" style="display:none;">
                                            <div class="p-3 rounded" style="background: rgba(0,0,0,0.3);">
                                                <small class="text-muted">Résultat:</small>
                                                <div class="font-monospace text-success" id="seriesResultRenamed"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Animés Tab -->
                    <div class="tab-pane fade" id="renameAnimeTab">
                        <div class="row g-4">
                            <div class="col-lg-6">
                                <div class="admin-card">
                                    <div class="admin-card-header">
                                        <h3 class="admin-card-title"><i class="bi bi-stars"></i>Configuration Animés
                                        </h3>
                                    </div>
                                    <div class="p-3">
                                        <div class="mb-3">
                                            <label class="form-label">Priorité audio</label>
                                            <div class="p-2 rounded" style="background: rgba(0,0,0,0.2);">
                                                <span class="badge bg-success">1. Multi (avec FR)</span>
                                                <i class="bi bi-arrow-right mx-2 text-muted"></i>
                                                <span class="badge bg-primary">2. VF</span>
                                                <i class="bi bi-arrow-right mx-2 text-muted"></i>
                                                <span class="badge bg-secondary">3. VOSTFR</span>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Sous-titres</label>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" checked disabled>
                                                <label class="form-check-label">Français uniquement</label>
                                            </div>
                                        </div>
                                        <hr>
                                        <div class="mb-3">
                                            <label class="form-label">Préférence titre anime</label>
                                            <select class="form-select" id="renameAnimeTitlePref">
                                                <option value="english">Titre anglais (ex: Attack on Titan)</option>
                                                <option value="romaji">Romanisé (ex: Shingeki no Kyojin)</option>
                                                <option value="japanese">Japonais</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Template de nommage</label>
                                            <textarea class="form-control font-monospace" id="renameAnimeFormat"
                                                rows="2">{title} ({year})/Season {season:02d}/{title} ({year}) - S{season:02d}E{episode:02d}</textarea>
                                            <div class="form-text">Variables: {title}, {year}, {season}, {episode}</div>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="animeIncludeTvdb">
                                            <label class="form-check-label" for="animeIncludeTvdb">
                                                Inclure ID TVDB <code>{tvdb-xxx}</code>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div class="admin-card">
                                    <div class="admin-card-header">
                                        <h3 class="admin-card-title"><i class="bi bi-bug"></i>Tester (Animé)</h3>
                                    </div>
                                    <div class="p-3">
                                        <div class="mb-3">
                                            <input type="text" class="form-control font-monospace"
                                                id="testAnimeFilename"
                                                placeholder="[SubsPlease] Jujutsu Kaisen - 45 (1080p).mkv">
                                        </div>
                                        <button class="btn btn-primary-custom w-100" onclick="testRename('anime')">
                                            <i class="bi bi-play me-1"></i>Tester le renommage
                                        </button>
                                        <div id="animeTestResult" class="mt-3" style="display:none;">
                                            <div class="p-3 rounded" style="background: rgba(0,0,0,0.3);">
                                                <small class="text-muted">Résultat:</small>
                                                <div class="font-monospace text-success" id="animeResultRenamed"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Variables Reference Card -->
                <div class="row g-4 mt-2">
                    <div class="col-12">
                        <div class="admin-card">
                            <div class="admin-card-header">
                                <h3 class="admin-card-title"><i class="bi bi-code-square"></i>Variables disponibles</h3>
                            </div>
                            <div class="p-3">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6 class="text-primary mb-2">Variables communes</h6>
                                        <table class="table table-sm table-dark-custom mb-3">
                                            <thead>
                                                <tr>
                                                    <th>Variable</th>
                                                    <th>Description</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td><code>{title}</code></td>
                                                    <td>Titre du média</td>
                                                </tr>
                                                <tr>
                                                    <td><code>{year}</code></td>
                                                    <td>Année de sortie</td>
                                                </tr>
                                                <tr>
                                                    <td><code>{quality}</code></td>
                                                    <td>Qualité (1080p, 720p...)</td>
                                                </tr>
                                            </tbody>
                                        </table>

                                        <h6 class="text-info mb-2">Variables séries/animés</h6>
                                        <table class="table table-sm table-dark-custom mb-0">
                                            <thead>
                                                <tr>
                                                    <th>Variable</th>
                                                    <th>Description</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td><code>{season}</code></td>
                                                    <td>Numéro de saison</td>
                                                </tr>
                                                <tr>
                                                    <td><code>{season:02d}</code></td>
                                                    <td>Saison sur 2 chiffres (01, 02...)</td>
                                                </tr>
                                                <tr>
                                                    <td><code>{episode}</code></td>
                                                    <td>Numéro d'épisode</td>
                                                </tr>
                                                <tr>
                                                    <td><code>{episode:02d}</code></td>
                                                    <td>Épisode sur 2 chiffres</td>
                                                </tr>
                                                <tr>
                                                    <td><code>{episode_title}</code></td>
                                                    <td>Titre de l'épisode</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="col-md-6">
                                        <h6 class="text-success mb-2">Exemples Plex</h6>
                                        <div class="p-2 rounded mb-2" style="background: rgba(0,0,0,0.3);">
                                            <small class="text-muted d-block">Film:</small>
                                            <code class="text-warning">{title} ({year})</code>
                                            <div class="text-success small">→ Avatar (2009)/Avatar (2009).mkv</div>
                                        </div>
                                        <div class="p-2 rounded mb-2" style="background: rgba(0,0,0,0.3);">
                                            <small class="text-muted d-block">Série:</small>
                                            <code
                                                class="text-warning">{title} ({year})/Season {season:02d}/{title} - S{season:02d}E{episode:02d}</code>
                                            <div class="text-success small">→ Breaking Bad (2008)/Season 01/Breaking Bad
                                                - S01E01.mkv</div>
                                        </div>
                                        <div class="p-2 rounded mb-2" style="background: rgba(0,0,0,0.3);">
                                            <small class="text-muted d-block">Animé:</small>
                                            <code
                                                class="text-warning">{title} ({year})/Season {season:02d}/{title} - S{season:02d}E{episode:02d}</code>
                                            <div class="text-success small">→ Attack on Titan (2013)/Season 01/Attack on
                                                Titan - S01E01.mkv</div>
                                        </div>
                                        <div class="p-2 rounded" style="background: rgba(0,0,0,0.3);">
                                            <small class="text-muted d-block">Avec titre épisode:</small>
                                            <code
                                                class="text-warning">{title} - S{season:02d}E{episode:02d} - {episode_title}</code>
                                            <div class="text-success small">→ Attack on Titan - S01E01 - To You, in 2000
                                                Years.mkv</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Global Settings & Mappings (shared across all types) -->
                <div class="row g-4 mt-2">
                    <div class="col-lg-4">
                        <div class="admin-card">
                            <div class="admin-card-header">
                                <h3 class="admin-card-title"><i class="bi bi-gear"></i>Options Globales</h3>
                            </div>
                            <div class="p-3">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="renameSpecialChars">
                                    <label class="form-check-label" for="renameSpecialChars">
                                        Remplacer caractères spéciaux (é→e)
                                    </label>
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="renameAiFallback" checked>
                                    <label class="form-check-label" for="renameAiFallback">
                                        Utiliser l'IA en fallback
                                    </label>
                                </div>
                                <button class="btn btn-primary-custom w-100" onclick="saveRenameSettings()">
                                    <i class="bi bi-check-lg me-2"></i>Enregistrer tout
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-8">
                        <div class="admin-card">
                            <div class="admin-card-header">
                                <h3 class="admin-card-title"><i class="bi bi-link-45deg"></i>Mappings Manuels</h3>
                                <button class="btn btn-primary-custom btn-sm" onclick="showAddMappingForm()">
                                    <i class="bi bi-plus-lg me-1"></i>Ajouter
                                </button>
                            </div>
                            <div id="addMappingForm" class="p-3 border-bottom"
                                style="display:none; background: rgba(0,0,0,0.2);">
                                <div class="row g-2">
                                    <div class="col-md-4">
                                        <input type="text" class="form-control" id="mappingPattern"
                                            placeholder="Pattern: *One.Piece*">
                                    </div>
                                    <div class="col-md-4">
                                        <input type="text" class="form-control" id="mappingPlexTitle"
                                            placeholder="Titre Plex: One Piece">
                                    </div>
                                    <div class="col-md-2">
                                        <select class="form-select" id="mappingMediaType">
                                            <option value="anime">Animé</option>
                                            <option value="series">Série</option>
                                            <option value="movie">Film</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <button class="btn btn-success w-100" onclick="addTitleMapping()">
                                            <i class="bi bi-check"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="table-responsive" style="max-height: 200px;">
                                <table class="table table-dark-custom mb-0 table-sm">
                                    <thead>
                                        <tr>
                                            <th>Pattern</th>
                                            <th>Titre Plex</th>
                                            <th>Type</th>
                                            <th style="width:60px;"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="mappingsBody">
                                        <tr>
                                            <td colspan="4" class="text-center py-3 text-muted">
                                                Aucun mapping défini
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Transfers Tab -->
            <div class="tab-pane fade" id="transfersTab">
                <!-- Stats Cards -->
                <div class="row g-4 mb-4">
                    <div class="col-6 col-lg-3">
                        <div class="stat-card">
                            <div class="stat-icon warning"><i class="bi bi-arrow-repeat"></i></div>
                            <div class="stat-info">
                                <h3 id="transfersInProgress">0</h3>
                                <p>En cours</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-lg-3">
                        <div class="stat-card">
                            <div class="stat-icon info"><i class="bi bi-hourglass-split"></i></div>
                            <div class="stat-info">
                                <h3 id="transfersPending">0</h3>
                                <p>En attente</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-lg-3">
                        <div class="stat-card">
                            <div class="stat-icon success"><i class="bi bi-check-circle"></i></div>
                            <div class="stat-info">
                                <h3 id="transfersCompleted">0</h3>
                                <p>Réussis (24h)</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-lg-3">
                        <div class="stat-card">
                            <div class="stat-icon primary"><i class="bi bi-hdd"></i></div>
                            <div class="stat-info">
                                <h3 id="transfersGB">0 Go</h3>
                                <p>Transféré (7j)</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row g-4">
                    <!-- Active Transfers -->
                    <div class="col-lg-8">
                        <div class="admin-card">
                            <div class="admin-card-header">
                                <h3 class="admin-card-title"><i class="bi bi-arrow-left-right"></i>Transferts actifs
                                </h3>
                                <button class="btn btn-primary-custom btn-sm" onclick="showForceTransferModal()">
                                    <i class="bi bi-plus-lg me-1"></i>Forcer
                                </button>
                            </div>
                            <div id="activeTransfersList" class="p-3">
                                <div class="text-center py-5">
                                    <i class="bi bi-inbox text-success" style="font-size: 3rem; opacity: 0.6;"></i>
                                    <p class="text-muted mt-3 mb-0">Aucun transfert en cours</p>
                                    <small class="text-muted">Les transferts apparaîtront ici
                                        automatiquement</small>
                                </div>
                            </div>
                        </div>

                        <!-- History -->
                        <div class="admin-card mt-4">
                            <div class="admin-card-header">
                                <h3 class="admin-card-title"><i class="bi bi-clock-history"></i>Historique récent
                                </h3>
                                <select class="form-select form-select-sm" id="transferHistoryFilter"
                                    style="width: auto;" onchange="loadTransferHistory()">
                                    <option value="">Tous</option>
                                    <option value="movie">Films</option>
                                    <option value="series">Séries</option>
                                    <option value="anime">Animés</option>
                                </select>
                            </div>
                            <div class="table-responsive" style="max-height: 300px;">
                                <table class="table table-dark-custom mb-0 table-sm">
                                    <thead>
                                        <tr>
                                            <th>Statut</th>
                                            <th>Média</th>
                                            <th>Destination</th>
                                            <th>Date</th>
                                            <th style="width:80px;"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="transferHistoryBody">
                                        <tr>
                                            <td colspan="5" class="text-center py-4">
                                                <i class="bi bi-clock text-muted" style="font-size: 1.5rem;"></i>
                                                <p class="text-muted mb-0 mt-2">Aucun transfert récent</p>
                                                <small class="text-muted">L'historique des 24 dernières heures
                                                    s'affichera ici</small>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Activity Log -->
                    <div class="col-lg-4">
                        <div class="admin-card">
                            <div class="admin-card-header">
                                <h3 class="admin-card-title"><i class="bi bi-chat-square-text"></i>Activité</h3>
                                <span class="badge bg-success" id="wsStatus">Connecté</span>
                            </div>
                            <div id="transferActivityLog" class="p-3" style="max-height: 500px; overflow-y: auto;">
                                <div class="text-center py-4">
                                    <i class="bi bi-broadcast text-info" style="font-size: 2rem; opacity: 0.6;"></i>
                                    <p class="text-muted mt-2 mb-0 small">Surveillance active</p>
                                    <small class="text-muted">Les événements s'afficheront en temps réel</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Create User Modal -->
    <div class="modal fade" id="createUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-person-plus me-2"></i>Créer un Utilisateur</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createUserForm">
                        <div class="mb-3">
                            <label class="form-label">Nom d'utilisateur *</label>
                            <input type="text" class="form-control" id="newUsername" required minlength="3">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" id="newEmail">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Mot de passe</label>
                            <input type="password" class="form-control" id="newPassword" minlength="8">
                            <div class="form-text">Min. 8 caractères.</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Rôle</label>
                            <select class="form-select" id="newRole">
                                <option value="user">Utilisateur</option>
                                <option value="admin">Administrateur</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary-custom" onclick="createUser()">Créer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div class="modal fade" id="editUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-pencil me-2"></i>Modifier l'Utilisateur</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editUserForm">
                        <input type="hidden" id="editUserId">
                        <div class="mb-3">
                            <label class="form-label">Nom d'utilisateur</label>
                            <input type="text" class="form-control" id="editUsername" disabled>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" id="editEmail">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Rôle</label>
                            <select class="form-select" id="editRole">
                                <option value="user">Utilisateur</option>
                                <option value="admin">Administrateur</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Statut</label>
                            <select class="form-select" id="editStatus">
                                <option value="active">Actif</option>
                                <option value="pending">En attente</option>
                                <option value="disabled">Désactivé</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary-custom" onclick="updateUser()">Enregistrer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- File Browser Modal -->
    <div class="modal fade" id="fileBrowserModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-folder2-open me-2"></i>Sélectionner un dossier</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Breadcrumb -->
                    <div class="mb-3 p-2" style="background: rgba(0,0,0,0.2); border-radius: 8px;">
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb mb-0" id="fileBrowserBreadcrumb"
                                style="--bs-breadcrumb-divider: '›';">
                                <li class="breadcrumb-item"><a href="#" onclick="browsePath('/')"><i
                                            class="bi bi-house-door"></i></a></li>
                            </ol>
                        </nav>
                    </div>

                    <!-- Current Path -->
                    <div class="mb-2 text-muted small">
                        <i class="bi bi-folder me-1"></i>Chemin actuel: <code id="fileBrowserCurrentPath">/</code>
                    </div>

                    <!-- Directory Listing -->
                    <div id="fileBrowserListing" style="max-height: 400px; overflow-y: auto;">
                        <div class="text-center py-4">
                            <div class="spinner-border spinner-border-sm text-primary"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary-custom" onclick="selectCurrentPath()">
                        <i class="bi bi-check-lg me-1"></i>Sélectionner ce dossier
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Series Modal -->
    <div class="modal fade" id="addSeriesModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-plus-lg me-2"></i>Ajouter une série au monitoring</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Search -->
                    <div class="mb-4">
                        <label class="form-label">Rechercher une série</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="seriesSearchInput"
                                   placeholder="Nom de la série ou de l'anime...">
                            <button class="btn btn-primary-custom" type="button" onclick="searchSeriesToAdd()">
                                <i class="bi bi-search me-1"></i>Rechercher
                            </button>
                        </div>
                    </div>

                    <!-- Search Results -->
                    <div id="seriesSearchResults" class="mb-4" style="display:none;">
                        <h6 class="text-muted mb-3">Résultats de recherche</h6>
                        <div id="seriesSearchResultsList" class="row g-2" style="max-height:300px; overflow-y:auto;">
                        </div>
                    </div>

                    <!-- Selected Series Info -->
                    <div id="selectedSeriesInfo" style="display:none;">
                        <hr class="border-secondary">
                        <h6 class="text-muted mb-3">Série sélectionnée</h6>
                        <div class="d-flex gap-3 mb-3">
                            <img id="selectedSeriesPoster" src="" alt="Poster"
                                 style="width:80px; height:120px; object-fit:cover; border-radius:8px;">
                            <div>
                                <h5 id="selectedSeriesTitle" class="mb-1"></h5>
                                <p id="selectedSeriesYear" class="text-muted small mb-2"></p>
                                <input type="hidden" id="selectedSeriesTmdbId">
                                <input type="hidden" id="selectedSeriesAnilistId">
                                <input type="hidden" id="selectedSeriesMediaType">
                                <input type="hidden" id="selectedSeriesPosterUrl">
                            </div>
                        </div>

                        <!-- Monitoring Options -->
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label small">Type de monitoring</label>
                                <select class="form-select form-select-sm" id="addSeriesMonitorType">
                                    <option value="new_episodes">Nouveaux épisodes</option>
                                    <option value="vostfr_upgrade">Upgrade VOSTFR → MULTI</option>
                                    <option value="both">Les deux</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label small">Qualité préférée</label>
                                <select class="form-select form-select-sm" id="addSeriesQuality">
                                    <option value="4k">4K</option>
                                    <option value="1080p" selected>1080p</option>
                                    <option value="720p">720p</option>
                                    <option value="any">N'importe laquelle</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label small">Audio préféré</label>
                                <select class="form-select form-select-sm" id="addSeriesAudio">
                                    <option value="multi" selected>MULTI (FR + VO)</option>
                                    <option value="vf">VF uniquement</option>
                                    <option value="vostfr">VOSTFR</option>
                                    <option value="any">N'importe lequel</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary-custom" onclick="addSeriesToMonitoring()" id="addSeriesBtn" disabled>
                        <i class="bi bi-plus-lg me-1"></i>Ajouter au monitoring
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const API_BASE = '/api/v1';
        let allUsers = [];

        document.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem('access_token');
            if (!token) {
                window.location.href = '/login.html';
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/auth/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const user = await response.json();

                if (user.role !== 'admin') {
                    window.location.href = '/';
                    return;
                }

                document.getElementById('userAvatar').textContent = user.username.charAt(0).toUpperCase();
            } catch (e) {
                window.location.href = '/login.html';
                return;
            }

            await refreshAll();
        });

        async function refreshAll() {
            // Load users FIRST (fast and critical for display)
            await loadUsers();

            // Then load other data in parallel (stats/health can be slow due to qBittorrent)
            Promise.all([
                loadStats(),
                loadHealth(),
                loadRequests(),
                loadConfig()
            ]).catch(e => console.warn('Background loading error:', e));
        }

        async function loadStats() {
            const token = localStorage.getItem('access_token');
            try {
                const response = await fetch(`${API_BASE}/admin/stats`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    const stats = await response.json();
                    document.getElementById('totalUsers').textContent = stats.users?.total || 0;
                    document.getElementById('pendingRequests').textContent = stats.requests?.by_status?.pending || 0;
                    document.getElementById('completedToday').textContent = stats.requests?.by_status?.completed || 0;
                }
            } catch (e) {
                console.log('Stats not available');
            }
        }

        async function loadHealth() {
            const token = localStorage.getItem('access_token');
            try {
                const response = await fetch(`${API_BASE}/admin/health`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    const health = await response.json();
                    updateHealthIndicator('qbitHealth', health.qbittorrent?.status === 'ok');
                    updateHealthIndicator('plexHealth', health.plex?.status === 'ok');
                    updateHealthIndicator('ollamaHealth', health.ollama?.status === 'ok');
                }
            } catch (e) {
                console.log('Health check not available');
            }
        }

        function updateHealthIndicator(id, status) {
            const el = document.getElementById(id);
            if (el) {
                el.className = `health-indicator ${status ? 'healthy' : 'unhealthy'}`;
            }
        }

        async function loadUsers() {
            const token = localStorage.getItem('access_token');
            const tbody = document.getElementById('usersBody');

            try {
                const response = await fetch(`${API_BASE}/admin/users`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    allUsers = await response.json();
                    const pendingUsers = allUsers.filter(u => u.status === 'pending');

                    // Update ALL user counts immediately from loaded data
                    document.getElementById('totalUsers').textContent = allUsers.length;
                    document.getElementById('pendingUsersCount').textContent = pendingUsers.length;
                    const badge = document.getElementById('pendingUsersBadge');
                    if (pendingUsers.length > 0) {
                        badge.textContent = pendingUsers.length;
                        badge.style.display = 'inline';
                    } else {
                        badge.style.display = 'none';
                    }

                    renderPendingUsers(pendingUsers);

                    tbody.innerHTML = allUsers.map(user => `
                        <tr>
                            <td>
                                <div class="d-flex align-items-center gap-2">
                                    <div class="user-avatar" style="width:36px;height:36px;font-size:0.9rem;">
                                        ${user.username.charAt(0).toUpperCase()}
                                    </div>
                                    <div>
                                        <strong>${user.username}</strong>
                                        ${user.plex_username ? `<div class="text-muted small">Plex: ${user.plex_username}</div>` : ''}
                                    </div>
                                </div>
                            </td>
                            <td>${user.email || '—'}</td>
                            <td><span class="badge ${user.role === 'admin' ? 'bg-primary' : 'bg-secondary'}">${user.role}</span></td>
                            <td><span class="status-badge ${user.status}">${user.status === 'active' ? 'Actif' : user.status === 'pending' ? 'En attente' : 'Désactivé'}</span></td>
                            <td>${user.daily_requests_count || 0}</td>
                            <td>${new Date(user.created_at).toLocaleDateString('fr-FR')}</td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    ${user.status === 'pending' ? `
                                        <button class="btn btn-success btn-sm" onclick="approveUser(${user.id})"><i class="bi bi-check-lg"></i></button>
                                        <button class="btn btn-danger btn-sm" onclick="rejectUser(${user.id})"><i class="bi bi-x-lg"></i></button>
                                    ` : ''}
                                    <button class="btn btn-outline-secondary btn-sm" onclick="showEditUserModal(${user.id})"><i class="bi bi-pencil"></i></button>
                                    ${user.role !== 'admin' ? `<button class="btn btn-outline-danger btn-sm" onclick="deleteUser(${user.id})"><i class="bi bi-trash"></i></button>` : ''}
                                </div>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (e) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-muted">Erreur de chargement</td></tr>';
            }
        }

        function renderPendingUsers(pendingUsers) {
            const section = document.getElementById('pendingUsersSection');
            const list = document.getElementById('pendingUsersList');
            const quickView = document.getElementById('pendingUsersQuick');

            if (pendingUsers.length === 0) {
                section.style.display = 'none';
                quickView.innerHTML = `<div class="text-center py-4 text-muted"><i class="bi bi-check-circle fs-1 mb-2 d-block"></i>Aucun utilisateur en attente</div>`;
                return;
            }

            section.style.display = 'block';

            const userCards = pendingUsers.map(user => `
                <div class="pending-user-card">
                    <div class="pending-user-avatar">${user.username.charAt(0).toUpperCase()}</div>
                    <div class="pending-user-info">
                        <strong>${user.username}</strong>
                        <small>${user.email || 'Pas d\'email'} • ${new Date(user.created_at).toLocaleDateString('fr-FR')}</small>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-success btn-sm" onclick="approveUser(${user.id})"><i class="bi bi-check-lg me-1"></i>Approuver</button>
                        <button class="btn btn-outline-danger btn-sm" onclick="rejectUser(${user.id})"><i class="bi bi-x-lg"></i></button>
                    </div>
                </div>
            `).join('');

            list.innerHTML = userCards;
            quickView.innerHTML = userCards;
        }

        async function loadRequests() {
            const token = localStorage.getItem('access_token');
            const tbody = document.getElementById('requestsBody');

            try {
                const response = await fetch(`${API_BASE}/requests?limit=50`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    const data = await response.json();
                    console.log('Requests API response:', data);
                    const requests = data.items || data.requests || data || [];

                    if (requests.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-muted">Aucune demande</td></tr>';
                        return;
                    }

                    const statusColors = { pending: 'warning', searching: 'info', downloading: 'primary', processing: 'info', completed: 'success', error: 'danger', cancelled: 'secondary' };

                    tbody.innerHTML = requests.map(req => {
                        const isCompleted = req.status === 'completed';
                        const isError = req.status === 'error';

                        let actionButtons = '';
                        if (isError) {
                            actionButtons += `<button class="btn btn-warning btn-sm" onclick="retryRequest(${req.id})" title="Réessayer"><i class="bi bi-arrow-repeat"></i></button>`;
                        }
                        if (!isCompleted) {
                            actionButtons += `<button class="btn btn-outline-danger btn-sm" onclick="deleteRequest(${req.id}, '${req.title.replace(/'/g, "\\'")}')" title="Supprimer"><i class="bi bi-trash"></i></button>`;
                        }

                        return `
                        <tr>
                            <td>
                                <div class="d-flex align-items-center gap-2">
                                    <img src="${req.poster_url || '/static/img/no-poster.png'}" style="width:40px;height:60px;object-fit:cover;border-radius:4px;">
                                    <div>
                                        <strong>${req.title}</strong>
                                        <div class="text-muted small">${req.media_type} ${req.year || ''}</div>
                                    </div>
                                </div>
                            </td>
                            <td>${req.username || 'Inconnu'}</td>
                            <td>
                                <span class="badge bg-${statusColors[req.status] || 'secondary'}">${req.status}</span>
                                ${req.status_message ? `<div class="text-muted small">${req.status_message}</div>` : ''}
                            </td>
                            <td>${new Date(req.created_at).toLocaleDateString('fr-FR')}</td>
                            <td><div class="d-flex gap-1">${actionButtons}</div></td>
                        </tr>
                    `}).join('');
                } else {
                    console.error('Requests API error:', response.status, await response.text());
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-muted">Erreur de chargement</td></tr>';
                }
            } catch (e) {
                console.error('loadRequests exception:', e);
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-muted">Erreur de chargement</td></tr>';
            }
        }

        async function deleteRequest(requestId, title) {
            if (!confirm(`Supprimer définitivement la demande "${title}" ?`)) {
                return;
            }

            const token = localStorage.getItem('access_token');
            try {
                const response = await fetch(`${API_BASE}/requests/${requestId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    showToast('Demande supprimée', 'success');
                    await loadRequests();
                    await loadStats();
                } else {
                    const error = await response.json();
                    showToast(error.detail || 'Erreur lors de la suppression', 'danger');
                }
            } catch (e) {
                console.error('Delete request error:', e);
                showToast('Erreur réseau', 'danger');
            }
        }

        async function loadConfig() {
            const token = localStorage.getItem('access_token');
            const configDisplay = document.getElementById('configDisplay');

            try {
                const response = await fetch(`${API_BASE}/admin/config`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    const config = await response.json();
                    configDisplay.innerHTML = `
                        <div class="row g-4">
                            <div class="col-md-6 config-section">
                                <h5><i class="bi bi-sliders me-2"></i>Limites</h5>
                                <ul class="config-list">
                                    <li><strong>Demandes/jour:</strong> ${config.max_requests_per_day}</li>
                                    <li><strong>Durée seed:</strong> ${config.seed_duration_hours}h</li>
                                    <li><strong>Taille max:</strong> ${config.max_download_size_gb} Go</li>
                                </ul>
                            </div>
                            <div class="col-md-6 config-section">
                                <h5><i class="bi bi-plug me-2"></i>Services</h5>
                                <ul class="config-list">
                                    <li><strong>Modèle AI:</strong> ${config.services?.ollama_model || 'Non configuré'}</li>
                                    <li><strong>Plex:</strong> ${config.services?.plex_configured ? '✅ Configuré' : '❌ Non configuré'}</li>
                                    <li><strong>YGG:</strong> ${config.services?.ygg_configured ? '✅ Configuré' : '❌ Non configuré'}</li>
                                    <li><strong>Discord:</strong> ${config.services?.discord_configured ? '✅ Configuré' : '❌ Non configuré'}</li>
                                </ul>
                            </div>
                        </div>
                    `;
                }
            } catch (e) {
                configDisplay.innerHTML = '<p class="text-muted">Configuration non disponible</p>';
            }
        }

        function showCreateUserModal() {
            document.getElementById('createUserForm').reset();
            new bootstrap.Modal(document.getElementById('createUserModal')).show();
        }

        async function createUser() {
            const token = localStorage.getItem('access_token');
            const data = {
                username: document.getElementById('newUsername').value,
                email: document.getElementById('newEmail').value || null,
                password: document.getElementById('newPassword').value || null,
                role: document.getElementById('newRole').value,
                status: 'active'
            };

            try {
                const response = await fetch(`${API_BASE}/admin/users`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    showToast('Utilisateur créé', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('createUserModal')).hide();
                    await loadUsers();
                    await loadStats();
                } else {
                    const error = await response.json();
                    showToast(error.detail || 'Erreur', 'danger');
                }
            } catch (e) {
                showToast('Erreur réseau', 'danger');
            }
        }

        function showEditUserModal(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;

            document.getElementById('editUserId').value = user.id;
            document.getElementById('editUsername').value = user.username;
            document.getElementById('editEmail').value = user.email || '';
            document.getElementById('editRole').value = user.role;
            document.getElementById('editStatus').value = user.status;

            new bootstrap.Modal(document.getElementById('editUserModal')).show();
        }

        async function updateUser() {
            const token = localStorage.getItem('access_token');
            const userId = document.getElementById('editUserId').value;
            const data = {
                email: document.getElementById('editEmail').value || null,
                role: document.getElementById('editRole').value,
                status: document.getElementById('editStatus').value
            };

            try {
                const response = await fetch(`${API_BASE}/admin/users/${userId}`, {
                    method: 'PATCH',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    showToast('Utilisateur mis à jour', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('editUserModal')).hide();
                    await loadUsers();
                } else {
                    const error = await response.json();
                    showToast(error.detail || 'Erreur', 'danger');
                }
            } catch (e) {
                showToast('Erreur réseau', 'danger');
            }
        }

        async function approveUser(userId) {
            const token = localStorage.getItem('access_token');
            try {
                const response = await fetch(`${API_BASE}/admin/users/${userId}/approve`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    showToast('Utilisateur approuvé', 'success');
                    await loadUsers();
                    await loadStats();
                } else {
                    const error = await response.json();
                    showToast(error.detail || 'Erreur', 'danger');
                }
            } catch (e) {
                showToast('Erreur', 'danger');
            }
        }

        async function rejectUser(userId) {
            if (!confirm('Rejeter cet utilisateur ?')) return;
            const token = localStorage.getItem('access_token');
            try {
                await fetch(`${API_BASE}/admin/users/${userId}/reject`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                showToast('Utilisateur rejeté', 'warning');
                await loadUsers();
                await loadStats();
            } catch (e) {
                showToast('Erreur', 'danger');
            }
        }

        async function deleteUser(userId) {
            if (!confirm('Supprimer cet utilisateur ?')) return;
            const token = localStorage.getItem('access_token');
            try {
                await fetch(`${API_BASE}/admin/users/${userId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                showToast('Utilisateur supprimé', 'success');
                await loadUsers();
                await loadStats();
            } catch (e) {
                showToast('Erreur', 'danger');
            }
        }

        function logout() {
            localStorage.clear();
            window.location.href = '/login.html';
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toastId = `toast-${Date.now()}`;
            container.insertAdjacentHTML('beforeend', `
                <div id="${toastId}" class="toast bg-${type} text-white" role="alert">
                    <div class="toast-body">${message}</div>
                </div>
            `);
            const toast = new bootstrap.Toast(document.getElementById(toastId), { delay: 3000 });
            toast.show();
        }

        // =========================================================================
        // LOGS MANAGEMENT
        // =========================================================================

        let logsState = {
            module: 'all',
            level: '',
            search: '',
            offset: 0,
            limit: 100,
            total: 0,
            autoRefreshInterval: null
        };

        // Initialize logs event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Module pills
            document.querySelectorAll('#logsModulePills button').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('#logsModulePills button').forEach(b => {
                        b.className = 'btn btn-sm btn-outline-secondary';
                    });
                    btn.className = 'btn btn-sm btn-primary';
                    logsState.module = btn.dataset.module;
                    logsState.offset = 0;
                    loadLogs();
                });
            });

            // Level filter
            document.getElementById('logsLevelFilter')?.addEventListener('change', (e) => {
                logsState.level = e.target.value;
                logsState.offset = 0;
                loadLogs();
            });

            // Search with debounce
            let searchTimeout;
            document.getElementById('logsSearch')?.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    logsState.search = e.target.value;
                    logsState.offset = 0;
                    loadLogs();
                }, 300);
            });

            // Auto-refresh toggle
            document.getElementById('logsAutoRefresh')?.addEventListener('change', (e) => {
                if (e.target.checked) {
                    logsState.autoRefreshInterval = setInterval(loadLogs, 5000);
                    loadLogs();
                } else {
                    clearInterval(logsState.autoRefreshInterval);
                    logsState.autoRefreshInterval = null;
                }
            });

            // Load logs when tab is shown
            document.querySelector('[data-bs-target="#logsTab"]')?.addEventListener('shown.bs.tab', () => {
                loadLogs();
            });
        });

        async function loadLogs(append = false) {
            const token = localStorage.getItem('access_token');
            const container = document.getElementById('logsContainer');

            if (!append) {
                container.innerHTML = '<div class="text-center py-4"><div class="spinner-border spinner-border-sm text-primary"></div></div>';
            }

            try {
                // Build query params
                const params = new URLSearchParams({
                    limit: logsState.limit,
                    offset: append ? logsState.offset : 0
                });
                if (logsState.level) params.append('level', logsState.level);
                if (logsState.search) params.append('search', logsState.search);

                const response = await fetch(`${API_BASE}/admin/logs/${logsState.module}?${params}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    logsState.total = data.total;
                    logsState.offset = data.offset + data.logs.length;

                    renderLogs(data.logs, append);
                    updateLogsStats(data.logs);
                    updateLogsPagination();
                } else {
                    container.innerHTML = '<div class="text-center py-4 text-danger">Erreur de chargement des logs</div>';
                }
            } catch (e) {
                console.error('loadLogs error:', e);
                container.innerHTML = '<div class="text-center py-4 text-danger">Erreur de connexion</div>';
            }
        }

        function renderLogs(logs, append = false) {
            const container = document.getElementById('logsContainer');

            if (!logs || logs.length === 0) {
                container.innerHTML = '<div class="text-center py-4 text-muted">Aucun log</div>';
                return;
            }

            const levelColors = {
                'DEBUG': 'text-muted',
                'INFO': 'text-info',
                'WARNING': 'text-warning',
                'ERROR': 'text-danger'
            };

            const levelBadges = {
                'DEBUG': 'bg-secondary',
                'INFO': 'bg-info',
                'WARNING': 'bg-warning text-dark',
                'ERROR': 'bg-danger'
            };

            const html = logs.map(log => {
                const timestamp = new Date(log.timestamp).toLocaleString('fr-FR');
                const levelClass = levelColors[log.level] || 'text-muted';
                const badgeClass = levelBadges[log.level] || 'bg-secondary';
                const message = escapeHtml(log.message);

                return `
                    <div class="log-entry d-flex gap-2 py-1 px-2 border-bottom border-dark" style="background: ${log.level === 'ERROR' ? 'rgba(220, 53, 69, 0.1)' : log.level === 'WARNING' ? 'rgba(255, 193, 7, 0.05)' : 'transparent'};">
                        <span class="text-muted" style="min-width: 140px; font-size: 0.75rem;">${timestamp}</span>
                        <span class="badge ${badgeClass}" style="min-width: 60px; font-size: 0.7rem;">${log.level}</span>
                        <span class="text-primary" style="min-width: 70px; font-size: 0.75rem;">${log.module}</span>
                        <span class="${levelClass}" style="word-break: break-word;">${message}</span>
                    </div>
                `;
            }).join('');

            if (append) {
                container.insertAdjacentHTML('beforeend', html);
            } else {
                container.innerHTML = html;
            }
        }

        function updateLogsStats(logs) {
            const stats = { INFO: 0, WARNING: 0, ERROR: 0 };
            logs.forEach(log => {
                if (stats[log.level] !== undefined) stats[log.level]++;
            });

            document.getElementById('logsInfoCount').textContent = stats.INFO;
            document.getElementById('logsWarningCount').textContent = stats.WARNING;
            document.getElementById('logsErrorCount').textContent = stats.ERROR;

            // Update error badge on tab
            const errorBadge = document.getElementById('logsErrorBadge');
            if (stats.ERROR > 0) {
                errorBadge.textContent = stats.ERROR;
                errorBadge.style.display = 'inline';
            } else {
                errorBadge.style.display = 'none';
            }
        }

        function updateLogsPagination() {
            const pagination = document.getElementById('logsPagination');
            const loadMoreBtn = document.getElementById('logsLoadMore');

            pagination.textContent = `Affichés: ${Math.min(logsState.offset, logsState.total)} sur ${logsState.total}`;

            if (logsState.offset < logsState.total) {
                loadMoreBtn.style.display = 'inline-block';
            } else {
                loadMoreBtn.style.display = 'none';
            }
        }

        function loadMoreLogs() {
            loadLogs(true);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        setInterval(refreshAll, 60000);

        // =========================================================================
        // MEDIA PATHS MANAGEMENT
        // =========================================================================

        let currentPathSettings = null;
        let fileBrowserTargetInput = null;
        let fileBrowserCurrentPath = '/';

        // Load path settings when Media tab is shown
        document.querySelector('[data-bs-target="#mediaPathsTab"]')?.addEventListener('shown.bs.tab', () => {
            loadPathSettings();
        });

        async function loadPathSettings() {
            const token = localStorage.getItem('access_token');
            try {
                const response = await fetch(`${API_BASE}/admin/settings/paths`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    currentPathSettings = await response.json();
                    renderPathSettings();
                } else {
                    console.error('Failed to load path settings');
                }
            } catch (e) {
                console.error('Error loading path settings:', e);
            }
        }

        function renderPathSettings() {
            if (!currentPathSettings) return;

            // Download path
            const downloadPath = currentPathSettings.download_path;
            document.getElementById('downloadPathInput').value = downloadPath?.path || '/downloads';
            document.getElementById('downloadPathStatus').innerHTML = getPathStatusBadge(downloadPath);

            // Library paths
            const tbody = document.getElementById('libraryPathsBody');
            const typeLabels = {
                'movie': '🎬 Films',
                'animated_movie': '🎨 Films Animation',
                'series': '📺 Séries TV',
                'animated_series': '🌀 Séries Animées',
                'anime': '⛩️ Animés (JAP)'
            };

            const paths = currentPathSettings.library_paths || {};
            tbody.innerHTML = Object.entries(typeLabels).map(([type, label]) => {
                const info = paths[type] || { path: '', exists: false, writable: false };
                return `
                    <tr>
                        <td><strong>${label}</strong></td>
                        <td>
                            <input type="text" class="form-control form-control-sm" 
                                   id="libraryPath_${type}" 
                                   value="${info.path || ''}" 
                                   placeholder="/media/...">
                        </td>
                        <td>${getPathStatusBadge(info)}</td>
                        <td>
                            <button class="btn btn-outline-primary btn-sm" onclick="openFileBrowser('libraryPath_${type}')">
                                <i class="bi bi-folder2-open"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function getPathStatusBadge(pathInfo) {
            if (!pathInfo) return '<span class="badge bg-secondary">Non configuré</span>';
            if (!pathInfo.exists) return '<span class="badge bg-danger">N\'existe pas</span>';
            if (!pathInfo.writable) return '<span class="badge bg-warning text-dark">Non writable</span>';
            return '<span class="badge bg-success">OK</span>';
        }

        async function savePathSettings() {
            const token = localStorage.getItem('access_token');

            const downloadPath = document.getElementById('downloadPathInput').value;
            const libraryPaths = {};

            ['movie', 'animated_movie', 'series', 'animated_series', 'anime'].forEach(type => {
                const input = document.getElementById(`libraryPath_${type}`);
                if (input) {
                    libraryPaths[type] = input.value;
                }
            });

            try {
                const response = await fetch(`${API_BASE}/admin/settings/paths?download_path=${encodeURIComponent(downloadPath)}&library_paths=${encodeURIComponent(JSON.stringify(libraryPaths))}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    showToast('Chemins enregistrés avec succès', 'success');
                    await loadPathSettings(); // Reload to get updated status
                } else {
                    const error = await response.json();
                    // Handle error.detail which can be string, array, or object
                    let errorMsg = 'Erreur lors de l\'enregistrement';
                    if (error.detail) {
                        if (typeof error.detail === 'string') {
                            errorMsg = error.detail;
                        } else if (Array.isArray(error.detail)) {
                            errorMsg = error.detail.join(', ');
                        } else if (typeof error.detail === 'object') {
                            errorMsg = JSON.stringify(error.detail);
                        }
                    }
                    showToast(errorMsg, 'danger');
                }
            } catch (e) {
                console.error('Error saving path settings:', e);
                showToast('Erreur réseau', 'danger');
            }
        }

        // =========================================================================
        // FILE BROWSER
        // =========================================================================

        function openFileBrowser(inputId) {
            fileBrowserTargetInput = document.getElementById(inputId);
            const currentValue = fileBrowserTargetInput?.value || '/';

            // Start browsing from current value or root
            const modal = new bootstrap.Modal(document.getElementById('fileBrowserModal'));
            modal.show();

            browsePath(currentValue || '/');
        }

        async function browsePath(path) {
            fileBrowserCurrentPath = path;
            document.getElementById('fileBrowserCurrentPath').textContent = path;

            const listing = document.getElementById('fileBrowserListing');
            listing.innerHTML = '<div class="text-center py-4"><div class="spinner-border spinner-border-sm text-primary"></div></div>';

            const token = localStorage.getItem('access_token');

            try {
                const response = await fetch(`${API_BASE}/admin/filesystem/browse?path=${encodeURIComponent(path)}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    renderDirectoryListing(data);
                    updateBreadcrumb(data.current_path);
                } else {
                    const error = await response.json();
                    listing.innerHTML = `<div class="text-center py-4 text-danger"><i class="bi bi-exclamation-triangle me-2"></i>${error.detail || 'Erreur'}</div>`;
                }
            } catch (e) {
                console.error('Error browsing:', e);
                listing.innerHTML = '<div class="text-center py-4 text-danger">Erreur de connexion</div>';
            }
        }

        function renderDirectoryListing(data) {
            const listing = document.getElementById('fileBrowserListing');

            if (!data.items || data.items.length === 0) {
                listing.innerHTML = '<div class="text-center py-4 text-muted">Dossier vide</div>';
                return;
            }

            listing.innerHTML = data.items.map(item => `
                <div class="file-browser-item d-flex align-items-center gap-2 p-2 rounded" 
                     style="cursor: pointer; border: 1px solid transparent;" 
                     onmouseover="this.style.background='rgba(139,92,246,0.1)'; this.style.borderColor='var(--primary)'"
                     onmouseout="this.style.background='transparent'; this.style.borderColor='transparent'"
                     onclick="browsePath('${item.path.replace(/'/g, "\\'")}')">
                    <i class="bi ${item.is_parent ? 'bi-arrow-up' : 'bi-folder-fill'}" 
                       style="color: ${item.is_parent ? 'var(--text-muted)' : 'var(--warning)'};"></i>
                    <span class="${item.is_parent ? 'text-muted' : ''}">${item.name}</span>
                    ${item.writable === false ? '<span class="badge bg-warning text-dark ms-auto small">Lecture seule</span>' : ''}
                </div>
            `).join('');
        }

        function updateBreadcrumb(path) {
            const breadcrumb = document.getElementById('fileBrowserBreadcrumb');
            const parts = path.split('/').filter(p => p);

            let html = '<li class="breadcrumb-item"><a href="#" onclick="browsePath(\'/\')"><i class="bi bi-house-door"></i></a></li>';
            let currentPath = '';

            parts.forEach((part, index) => {
                currentPath += '/' + part;
                const isLast = index === parts.length - 1;
                if (isLast) {
                    html += `<li class="breadcrumb-item active">${part}</li>`;
                } else {
                    html += `<li class="breadcrumb-item"><a href="#" onclick="browsePath('${currentPath}')">${part}</a></li>`;
                }
            });

            breadcrumb.innerHTML = html;
        }

        function selectCurrentPath() {
            if (fileBrowserTargetInput) {
                fileBrowserTargetInput.value = fileBrowserCurrentPath;
            }
            bootstrap.Modal.getInstance(document.getElementById('fileBrowserModal')).hide();
        }

        // =========================================================================
        // RENAME SETTINGS
        // =========================================================================

        async function loadRenameSettings() {
            const token = localStorage.getItem('access_token');

            try {
                const response = await fetch(`${API_BASE}/admin/settings/rename`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const settings = await response.json();

                    // Populate form fields
                    document.getElementById('renameMovieFormat').value = settings.movie_format || '{title} ({year})';
                    document.getElementById('renameSeriesFormat').value = settings.series_format || '{title} ({year})/Season {season:02d}/{title} ({year}) - S{season:02d}E{episode:02d}';
                    document.getElementById('renameAnimeFormat').value = settings.anime_format || '{title} ({year})/Season {season:02d}/{title} ({year}) - S{season:02d}E{episode:02d}';
                    document.getElementById('renameAnimeTitlePref').value = settings.anime_title_preference || 'english';

                    // Checkboxes
                    const movieTmdb = document.getElementById('movieIncludeTmdb');
                    if (movieTmdb) movieTmdb.checked = settings.include_tmdb_id || false;

                    const seriesTvdb = document.getElementById('seriesIncludeTvdb');
                    if (seriesTvdb) seriesTvdb.checked = settings.include_tvdb_id || false;

                    const animeTvdb = document.getElementById('animeIncludeTvdb');
                    if (animeTvdb) animeTvdb.checked = settings.include_tvdb_id || false;

                    document.getElementById('renameSpecialChars').checked = settings.replace_special_chars || false;
                    document.getElementById('renameAiFallback').checked = settings.use_ai_fallback !== false;
                }
            } catch (e) {
                console.error('Error loading rename settings:', e);
            }
        }

        async function saveRenameSettings() {
            const token = localStorage.getItem('access_token');

            const settings = {
                // Audio preference is fixed: MULTI -> VF -> VOSTFR
                preferred_language: 'multi_vf_vostfr',
                // Subtitles: French only (fixed)
                subtitle_language: 'french',
                // Templates per type
                movie_format: document.getElementById('renameMovieFormat').value,
                series_format: document.getElementById('renameSeriesFormat').value,
                anime_format: document.getElementById('renameAnimeFormat').value,
                // Anime specific
                anime_title_preference: document.getElementById('renameAnimeTitlePref').value,
                // IDs
                include_tmdb_id: document.getElementById('movieIncludeTmdb')?.checked || false,
                include_tvdb_id: document.getElementById('seriesIncludeTvdb')?.checked || document.getElementById('animeIncludeTvdb')?.checked || false,
                // Global options
                replace_special_chars: document.getElementById('renameSpecialChars').checked,
                use_ai_fallback: document.getElementById('renameAiFallback').checked
            };

            try {
                const response = await fetch(`${API_BASE}/admin/settings/rename`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settings)
                });

                if (response.ok) {
                    showToast('Paramètres de renommage enregistrés', 'success');
                } else {
                    const error = await response.json();
                    showToast(error.detail || 'Erreur', 'danger');
                }
            } catch (e) {
                console.error('Error saving rename settings:', e);
                showToast('Erreur de connexion', 'danger');
            }
        }

        async function testRename(mediaType) {
            const token = localStorage.getItem('access_token');

            // Get the correct input field based on media type
            let filenameInput, resultDiv, resultEl;
            if (mediaType === 'movie') {
                filenameInput = document.getElementById('testMovieFilename');
                resultDiv = document.getElementById('movieTestResult');
                resultEl = document.getElementById('movieResultRenamed');
            } else if (mediaType === 'series') {
                filenameInput = document.getElementById('testSeriesFilename');
                resultDiv = document.getElementById('seriesTestResult');
                resultEl = document.getElementById('seriesResultRenamed');
            } else {
                filenameInput = document.getElementById('testAnimeFilename');
                resultDiv = document.getElementById('animeTestResult');
                resultEl = document.getElementById('animeResultRenamed');
            }

            const filename = filenameInput?.value;

            if (!filename) {
                showToast('Entrez un nom de fichier', 'warning');
                return;
            }

            resultDiv.style.display = 'none';

            try {
                const params = new URLSearchParams({
                    filename: filename,
                    media_type: mediaType
                });

                const response = await fetch(`${API_BASE}/admin/settings/rename/preview?${params}`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const result = await response.json();
                    resultEl.textContent = result.folder_structure;
                    resultDiv.style.display = 'block';
                } else {
                    const error = await response.json();
                    showToast(error.detail || 'Erreur de test', 'danger');
                }
            } catch (e) {
                console.error('Error testing rename:', e);
                showToast('Erreur de connexion', 'danger');
            }
        }

        // =========================================================================
        // TITLE MAPPINGS
        // =========================================================================

        async function loadTitleMappings() {
            const token = localStorage.getItem('access_token');
            const tbody = document.getElementById('mappingsBody');

            try {
                const response = await fetch(`${API_BASE}/admin/settings/rename/mappings`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    const mappings = data.mappings || [];

                    if (mappings.length === 0) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="4" class="text-center py-4 text-muted">
                                    Aucun mapping défini
                                </td>
                            </tr>
                        `;
                        return;
                    }

                    tbody.innerHTML = mappings.map(m => `
                        <tr>
                            <td><code>${m.pattern}</code></td>
                            <td>${m.plex_title}</td>
                            <td><span class="badge bg-secondary">${m.media_type}</span></td>
                            <td>
                                <button class="btn btn-outline-danger btn-sm" onclick="deleteTitleMapping(${m.id})">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (e) {
                console.error('Error loading mappings:', e);
            }
        }

        function showAddMappingForm() {
            const form = document.getElementById('addMappingForm');
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
        }

        async function addTitleMapping() {
            const token = localStorage.getItem('access_token');
            const pattern = document.getElementById('mappingPattern').value;
            const plexTitle = document.getElementById('mappingPlexTitle').value;
            const mediaType = document.getElementById('mappingMediaType').value;

            if (!pattern || !plexTitle) {
                showToast('Remplissez tous les champs', 'warning');
                return;
            }

            try {
                const params = new URLSearchParams({
                    pattern: pattern,
                    plex_title: plexTitle,
                    media_type: mediaType
                });

                const response = await fetch(`${API_BASE}/admin/settings/rename/mappings?${params}`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    showToast('Mapping ajouté', 'success');
                    document.getElementById('mappingPattern').value = '';
                    document.getElementById('mappingPlexTitle').value = '';
                    document.getElementById('addMappingForm').style.display = 'none';
                    loadTitleMappings();
                } else {
                    const error = await response.json();
                    showToast(error.detail || 'Erreur', 'danger');
                }
            } catch (e) {
                console.error('Error adding mapping:', e);
                showToast('Erreur de connexion', 'danger');
            }
        }

        async function deleteTitleMapping(id) {
            if (!confirm('Supprimer ce mapping ?')) return;

            const token = localStorage.getItem('access_token');

            try {
                const response = await fetch(`${API_BASE}/admin/settings/rename/mappings/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    showToast('Mapping supprimé', 'success');
                    loadTitleMappings();
                } else {
                    const error = await response.json();
                    showToast(error.detail || 'Erreur', 'danger');
                }
            } catch (e) {
                console.error('Error deleting mapping:', e);
                showToast('Erreur de connexion', 'danger');
            }
        }

        // Load rename settings when tab is shown
        document.querySelector('[data-bs-target="#renameTab"]')?.addEventListener('shown.bs.tab', () => {
            loadRenameSettings();
            loadTitleMappings();
        });

        // =========================================================================
        // TRANSFERS MANAGEMENT
        // =========================================================================

        let transfersWs = null;

        function initTransfersWebSocket() {
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${wsProtocol}//${window.location.host}/api/v1/transfers/ws`;

            try {
                transfersWs = new WebSocket(wsUrl);

                transfersWs.onopen = () => {
                    document.getElementById('wsStatus').className = 'badge bg-success';
                    document.getElementById('wsStatus').textContent = 'Connecté';
                    addActivityLog('✨ Connexion temps réel établie');
                };

                transfersWs.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    handleTransferUpdate(data);
                };

                transfersWs.onclose = () => {
                    document.getElementById('wsStatus').className = 'badge bg-danger';
                    document.getElementById('wsStatus').textContent = 'Déconnecté';
                    // Try to reconnect after 5 seconds
                    setTimeout(initTransfersWebSocket, 5000);
                };

                transfersWs.onerror = () => {
                    document.getElementById('wsStatus').className = 'badge bg-warning';
                    document.getElementById('wsStatus').textContent = 'Erreur';
                };

                // Ping every 30s to keep connection alive
                setInterval(() => {
                    if (transfersWs && transfersWs.readyState === WebSocket.OPEN) {
                        transfersWs.send('ping');
                    }
                }, 30000);
            } catch (e) {
                console.error('WebSocket error:', e);
            }
        }

        function handleTransferUpdate(data) {
            if (data.type === 'transfer_progress' || data.type === 'transfer_update') {
                updateActiveTransfer(data.transfer);
                addActivityLog(formatTransferLog(data.transfer));
            } else if (data.type === 'transfer_new') {
                loadActiveTransfers();
                addActivityLog(`📦 Nouveau transfert: ${data.transfer.media_title || data.transfer.original_filename}`);
            } else if (data.type === 'transfer_cancelled') {
                loadActiveTransfers();
                addActivityLog('🚫 Transfert annulé');
            }

            // Refresh stats
            loadTransferStats();
        }

        function formatTransferLog(transfer) {
            const emoji = {
                'pending': '⏳',
                'in_progress': '📦',
                'completed': '✅',
                'failed': '❌',
                'cancelled': '🚫'
            }[transfer.status] || '❓';

            const title = transfer.media_title || transfer.original_filename;

            if (transfer.status === 'completed') {
                return `${emoji} "${title}" déplacé avec succès`;
            } else if (transfer.status === 'failed') {
                return `${emoji} "${title}" a échoué`;
            } else if (transfer.status === 'in_progress') {
                return `${emoji} "${title}" en cours (${Math.round(transfer.progress)}%)`;
            }
            return `${emoji} "${title}"`;
        }

        function addActivityLog(message) {
            const log = document.getElementById('transferActivityLog');
            const entry = document.createElement('div');
            entry.className = 'transfer-log-entry mb-2 p-2 rounded';
            entry.style.background = 'rgba(0,0,0,0.2)';

            const time = new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
            entry.innerHTML = `
                <div class="d-flex justify-content-between">
                    <span>${message}</span>
                    <small class="text-muted">${time}</small>
                </div>
            `;

            log.insertBefore(entry, log.firstChild);

            // Keep only last 50 entries
            while (log.children.length > 50) {
                log.removeChild(log.lastChild);
            }
        }

        async function loadTransferStats() {
            const token = localStorage.getItem('access_token');

            try {
                const response = await fetch(`${API_BASE}/transfers/stats`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const stats = await response.json();
                    document.getElementById('transfersInProgress').textContent = stats.in_progress;
                    document.getElementById('transfersPending').textContent = stats.pending;
                    document.getElementById('transfersCompleted').textContent = stats.today.completed;
                    document.getElementById('transfersGB').textContent = `${stats.week_gb_transferred} Go`;

                    // Update badge
                    const badge = document.getElementById('transfersInProgressBadge');
                    if (stats.in_progress > 0) {
                        badge.textContent = stats.in_progress;
                        badge.style.display = 'inline';
                    } else {
                        badge.style.display = 'none';
                    }
                }
            } catch (e) {
                console.error('Error loading transfer stats:', e);
            }
        }

        async function loadActiveTransfers() {
            const token = localStorage.getItem('access_token');

            try {
                const response = await fetch(`${API_BASE}/transfers/active`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    const container = document.getElementById('activeTransfersList');

                    if (data.active.length === 0) {
                        container.innerHTML = `
                            <div class="text-center text-muted py-4">
                                <i class="bi bi-check-circle fs-1 mb-2 d-block"></i>
                                Aucun transfert en cours
                            </div>
                        `;
                    } else {
                        container.innerHTML = data.active.map(t => renderActiveTransfer(t)).join('');
                    }
                }
            } catch (e) {
                console.error('Error loading active transfers:', e);
            }
        }

        function renderActiveTransfer(transfer) {
            const statusClass = transfer.status === 'in_progress' ? 'progress-bar-striped progress-bar-animated' : '';
            const title = transfer.media_title || transfer.original_filename;

            return `
                <div class="p-3 mb-2 rounded" style="background: rgba(0,0,0,0.3);" id="transfer-${transfer.id}">
                    <div class="d-flex justify-content-between mb-2">
                        <strong>${title}</strong>
                        <span class="badge bg-${transfer.status === 'in_progress' ? 'warning' : 'secondary'}">${transfer.status}</span>
                    </div>
                    <div class="progress mb-2" style="height: 8px;">
                        <div class="progress-bar bg-primary ${statusClass}" style="width: ${transfer.progress}%"></div>
                    </div>
                    <div class="d-flex justify-content-between">
                        <small class="text-muted">→ ${transfer.media_type}</small>
                        <small>${Math.round(transfer.progress)}%</small>
                    </div>
                </div>
            `;
        }

        function updateActiveTransfer(transfer) {
            const el = document.getElementById(`transfer-${transfer.id}`);
            if (el) {
                el.outerHTML = renderActiveTransfer(transfer);
            } else {
                loadActiveTransfers();
            }
        }

        async function loadTransferHistory() {
            const token = localStorage.getItem('access_token');
            const filter = document.getElementById('transferHistoryFilter')?.value || '';

            try {
                let url = `${API_BASE}/transfers?hours=24&limit=20`;
                if (filter) url += `&media_type=${filter}`;

                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    const tbody = document.getElementById('transferHistoryBody');

                    if (data.transfers.length === 0) {
                        tbody.innerHTML = `<tr><td colspan="5" class="text-center py-3 text-muted">Aucun transfert récent</td></tr>`;
                    } else {
                        tbody.innerHTML = data.transfers.map(t => {
                            const statusIcon = {
                                'completed': '<i class="bi bi-check-circle text-success"></i>',
                                'failed': '<i class="bi bi-x-circle text-danger"></i>',
                                'pending': '<i class="bi bi-hourglass-split text-warning"></i>',
                                'in_progress': '<i class="bi bi-arrow-repeat text-info"></i>',
                                'cancelled': '<i class="bi bi-slash-circle text-secondary"></i>'
                            }[t.status] || '';

                            const date = t.completed_at || t.created_at;
                            const timeAgo = date ? formatTimeAgo(new Date(date)) : '-';
                            const title = t.media_title || t.original_filename;
                            const canRetry = t.status === 'failed';

                            return `
                                <tr>
                                    <td>${statusIcon}</td>
                                    <td>${title.substring(0, 30)}${title.length > 30 ? '...' : ''}</td>
                                    <td>${t.media_type}</td>
                                    <td><small>${timeAgo}</small></td>
                                    <td>
                                        ${canRetry ? `<button class="btn btn-sm btn-outline-warning" onclick="retryTransfer(${t.id})"><i class="bi bi-arrow-clockwise"></i></button>` : ''}
                                    </td>
                                </tr>
                            `;
                        }).join('');
                    }
                }
            } catch (e) {
                console.error('Error loading transfer history:', e);
            }
        }

        function formatTimeAgo(date) {
            const now = new Date();
            const diff = Math.floor((now - date) / 1000);

            if (diff < 60) return 'à l\'instant';
            if (diff < 3600) return `il y a ${Math.floor(diff / 60)}m`;
            if (diff < 86400) return `il y a ${Math.floor(diff / 3600)}h`;
            return `il y a ${Math.floor(diff / 86400)}j`;
        }

        async function retryTransfer(id) {
            const token = localStorage.getItem('access_token');

            try {
                const response = await fetch(`${API_BASE}/transfers/${id}/retry`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    showToast('Transfert relancé', 'success');
                    loadActiveTransfers();
                    loadTransferHistory();
                    loadTransferStats();
                } else {
                    const error = await response.json();
                    showToast(error.detail || 'Erreur', 'danger');
                }
            } catch (e) {
                console.error('Error retrying transfer:', e);
                showToast('Erreur de connexion', 'danger');
            }
        }

        function showForceTransferModal() {
            // For now, use prompt - could be a modal later
            const path = prompt('Chemin du fichier à transférer:');
            if (!path) return;

            const type = prompt('Type de média (movie, series, anime):');
            if (!type) return;

            if (!confirm(`Forcer le transfert de "${path}" vers ${type} ?`)) return;

            forceTransfer(path, type);
        }

        async function forceTransfer(path, mediaType) {
            const token = localStorage.getItem('access_token');

            try {
                const response = await fetch(`${API_BASE}/transfers/force?original_path=${encodeURIComponent(path)}&media_type=${mediaType}`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    showToast('Transfert forcé créé', 'success');
                    loadActiveTransfers();
                    loadTransferStats();
                } else {
                    const error = await response.json();
                    showToast(error.detail || 'Erreur', 'danger');
                }
            } catch (e) {
                console.error('Error forcing transfer:', e);
                showToast('Erreur de connexion', 'danger');
            }
        }

        // Load transfers when tab is shown
        document.querySelector('[data-bs-target="#transfersTab"]')?.addEventListener('shown.bs.tab', () => {
            loadTransferStats();
            loadActiveTransfers();
            loadTransferHistory();
            if (!transfersWs || transfersWs.readyState !== WebSocket.OPEN) {
                initTransfersWebSocket();
            }
        });

        // =========================================================================
        // SERVICES CONFIGURATION
        // =========================================================================

        const serviceIcons = {
            plex: 'bi-play-circle',
            qbittorrent: 'bi-download',
            ai: 'bi-robot',
            ygg: 'bi-magnet',
            tmdb: 'bi-film',
            discord: 'bi-discord',
            flaresolverr: 'bi-shield-check',
            yggapi: 'bi-cloud'
        };

        const serviceNames = {
            plex: 'Plex',
            qbittorrent: 'qBittorrent',
            ai: 'IA',
            ygg: 'YGG',
            tmdb: 'TMDB',
            discord: 'Discord',
            flaresolverr: 'FlareSolverr',
            yggapi: 'YggAPI'
        };

        async function loadServicesConfig() {
            const token = localStorage.getItem('access_token');

            try {
                const response = await fetch(`${API_BASE}/services`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const services = await response.json();
                    populateServicesForm(services);
                }
            } catch (e) {
                console.error('Error loading services config:', e);
            }
        }

        function populateServicesForm(services) {
            services.forEach(service => {
                const name = service.service_name;
                const config = service.config || {};

                // Set URL
                const urlInput = document.getElementById(`${name}-url`);
                if (urlInput) urlInput.value = config.url || '';

                // Set username
                const usernameInput = document.getElementById(`${name}-username`);
                if (usernameInput) usernameInput.value = config.username || '';

                // Set enabled status
                const enabledCheckbox = document.getElementById(`${name}-enabled`);
                if (enabledCheckbox) enabledCheckbox.checked = config.is_enabled !== false;

                // Handle AI extra config
                if (name === 'ai' && config.extra_config) {
                    const providerSelect = document.getElementById('ai-provider-type');
                    if (providerSelect) providerSelect.value = config.extra_config.provider_type || 'llama_cpp';

                    const modelScoringSelect = document.getElementById('ai-model-scoring');
                    const modelRenameSelect = document.getElementById('ai-model-rename');
                    const modelAnalysisSelect = document.getElementById('ai-model-analysis');

                    // Store configured models for later use
                    window.aiConfiguredModels = {
                        scoring: config.extra_config.model_scoring || '',
                        rename: config.extra_config.model_rename || '',
                        analysis: config.extra_config.model_analysis || ''
                    };

                    // Show models section if models are configured
                    if (config.extra_config.model_scoring || config.extra_config.model_rename || config.extra_config.model_analysis) {
                        document.getElementById('ai-models-section').style.display = 'block';
                        // Add configured models as options
                        [modelScoringSelect, modelRenameSelect, modelAnalysisSelect].forEach(select => {
                            if (select) {
                                select.innerHTML = '<option value="">-- Sélectionner --</option>';
                                const models = new Set([
                                    config.extra_config.model_scoring,
                                    config.extra_config.model_rename,
                                    config.extra_config.model_analysis
                                ].filter(Boolean));
                                models.forEach(model => {
                                    const option = document.createElement('option');
                                    option.value = model;
                                    option.textContent = model;
                                    select.appendChild(option);
                                });
                            }
                        });
                        if (modelScoringSelect) modelScoringSelect.value = config.extra_config.model_scoring || '';
                        if (modelRenameSelect) modelRenameSelect.value = config.extra_config.model_rename || '';
                        if (modelAnalysisSelect) modelAnalysisSelect.value = config.extra_config.model_analysis || '';
                    }

                    updateAIUrlHint();
                }

                // Update health dot
                updateHealthDot(name, config.last_health_status);

                // Update status message
                const statusEl = document.getElementById(`${name}-status`);
                if (statusEl && config.last_health_message) {
                    statusEl.innerHTML = `<span class="text-${config.last_health_status === 'ok' ? 'success' : 'muted'}">${config.last_health_message}</span>`;
                }
            });
        }

        function updateHealthDot(serviceName, status) {
            const dot = document.getElementById(`${serviceName}-health-dot`);
            if (dot) {
                dot.className = `health-dot ms-2 ${status || ''}`;
            }
        }

        async function refreshAllServicesHealth() {
            const token = localStorage.getItem('access_token');
            const container = document.getElementById('servicesHealthCards');

            container.innerHTML = `
                <div class="text-center py-3 w-100">
                    <div class="spinner-border spinner-border-sm text-primary"></div>
                    <span class="ms-2 text-muted">Vérification en cours...</span>
                </div>
            `;

            try {
                const response = await fetch(`${API_BASE}/services/health/all`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    renderServicesHealthCards(data.services, data.summary);

                    // Update individual health dots
                    Object.entries(data.services).forEach(([name, health]) => {
                        updateHealthDot(name, health.status);
                    });
                }
            } catch (e) {
                console.error('Error refreshing services health:', e);
                container.innerHTML = '<p class="text-danger">Erreur lors de la vérification</p>';
            }
        }

        function renderServicesHealthCards(services, summary) {
            const container = document.getElementById('servicesHealthCards');

            let html = '';

            // Summary badge
            html += `
                <div class="w-100 mb-3">
                    <span class="badge ${summary.overall_status === 'ok' ? 'bg-success' : summary.overall_status === 'degraded' ? 'bg-warning' : 'bg-danger'} me-2">
                        ${summary.ok}/${summary.total} services OK
                    </span>
                    ${summary.error > 0 ? `<span class="badge bg-danger">${summary.error} en erreur</span>` : ''}
                    ${summary.not_configured > 0 ? `<span class="badge bg-secondary ms-1">${summary.not_configured} non configurés</span>` : ''}
                </div>
            `;

            // Service cards
            Object.entries(services).forEach(([name, health]) => {
                const icon = serviceIcons[name] || 'bi-gear';
                const displayName = serviceNames[name] || name;

                html += `
                    <div class="service-health-card ${health.status}">
                        <div class="service-icon"><i class="bi ${icon}"></i></div>
                        <div class="service-name">${displayName}</div>
                        <div class="service-status">
                            <span class="health-dot ${health.status}"></span>
                            ${health.latency_ms ? `${health.latency_ms}ms` : health.status === 'not_configured' ? 'Non configuré' : health.status}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        async function testServiceConnection(serviceName) {
            const token = localStorage.getItem('access_token');
            const statusEl = document.getElementById(`${serviceName}-status`);

            statusEl.innerHTML = '<span class="text-muted"><i class="bi bi-hourglass-split me-1"></i>Test en cours...</span>';

            // Build config from form
            const config = getServiceConfigFromForm(serviceName);

            try {
                const response = await fetch(`${API_BASE}/services/${serviceName}/test`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });

                const result = await response.json();

                updateHealthDot(serviceName, result.status);

                if (result.status === 'ok') {
                    statusEl.innerHTML = `<span class="text-success"><i class="bi bi-check-circle me-1"></i>${result.message}</span>`;
                    showToast(`${serviceNames[serviceName]}: Connexion réussie`, 'success');
                } else {
                    statusEl.innerHTML = `<span class="text-danger"><i class="bi bi-x-circle me-1"></i>${result.message}</span>`;
                    showToast(`${serviceNames[serviceName]}: ${result.message}`, 'danger');
                }
            } catch (e) {
                console.error('Error testing service:', e);
                statusEl.innerHTML = '<span class="text-danger">Erreur de connexion</span>';
                showToast('Erreur réseau', 'danger');
            }
        }

        // AI-specific functions
        async function testAIConnection() {
            const token = localStorage.getItem('access_token');
            const statusEl = document.getElementById('ai-status');
            const modelsSection = document.getElementById('ai-models-section');

            statusEl.innerHTML = '<span class="text-muted"><i class="bi bi-hourglass-split me-1"></i>Test en cours...</span>';

            const testConfig = {
                provider_type: document.getElementById('ai-provider-type')?.value || 'llama_cpp',
                base_url: document.getElementById('ai-url')?.value || null,
                api_key: document.getElementById('ai-api-key')?.value || null
            };

            try {
                const response = await fetch(`${API_BASE}/admin/ai/test`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testConfig)
                });

                const result = await response.json();

                if (result.status === 'ok') {
                    statusEl.innerHTML = `<span class="text-success"><i class="bi bi-check-circle me-1"></i>${result.models.length} modèle(s) disponible(s)</span>`;
                    updateHealthDot('ai', 'ok');

                    // Populate model dropdowns
                    populateAIModelDropdowns(result.models);
                    modelsSection.style.display = 'block';

                    showToast('Connexion IA réussie', 'success');
                } else {
                    statusEl.innerHTML = `<span class="text-danger"><i class="bi bi-x-circle me-1"></i>${result.message}</span>`;
                    updateHealthDot('ai', 'error');
                    showToast(`IA: ${result.message}`, 'danger');
                }
            } catch (e) {
                console.error('Error testing AI:', e);
                statusEl.innerHTML = '<span class="text-danger">Erreur réseau</span>';
                updateHealthDot('ai', 'error');
                showToast('Erreur réseau', 'danger');
            }
        }

        function populateAIModelDropdowns(models) {
            const selects = ['ai-model-scoring', 'ai-model-rename', 'ai-model-analysis'];
            const configured = window.aiConfiguredModels || {};

            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (!select) return;

                const currentValue = select.value;
                select.innerHTML = '<option value="">-- Sélectionner --</option>';

                models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.id;
                    option.textContent = model.id;
                    select.appendChild(option);
                });

                // Restore value
                const configKey = selectId.replace('ai-model-', '');
                if (currentValue) {
                    select.value = currentValue;
                } else if (configured[configKey]) {
                    select.value = configured[configKey];
                } else if (models.length > 0) {
                    // Default to first model
                    select.value = models[0].id;
                }
            });
        }

        function updateAIUrlHint() {
            const providerType = document.getElementById('ai-provider-type')?.value;
            const hintEl = document.getElementById('ai-url-hint');
            if (!hintEl) return;

            const hints = {
                'llama_cpp': 'Ex: http://localhost:8080',
                'openai': 'https://api.openai.com',
                'openrouter': 'https://openrouter.ai'
            };
            hintEl.textContent = hints[providerType] || 'Ex: http://localhost:8080';
        }

        function togglePasswordVisibility(inputId) {
            const input = document.getElementById(inputId);
            if (!input) return;

            if (input.type === 'password') {
                input.type = 'text';
            } else {
                input.type = 'password';
            }
        }

        function getServiceConfigFromForm(serviceName) {
            const config = {
                url: document.getElementById(`${serviceName}-url`)?.value || null,
                username: document.getElementById(`${serviceName}-username`)?.value || null,
                password: document.getElementById(`${serviceName}-password`)?.value || null,
                api_key: document.getElementById(`${serviceName}-api-key`)?.value || null,
                token: document.getElementById(`${serviceName}-token`)?.value || null,
                is_enabled: document.getElementById(`${serviceName}-enabled`)?.checked ?? true,
                extra_config: null
            };

            // Handle AI-specific fields
            if (serviceName === 'ai') {
                config.api_key = document.getElementById('ai-api-key')?.value || null;
                config.extra_config = {
                    provider_type: document.getElementById('ai-provider-type')?.value || 'llama_cpp',
                    model_scoring: document.getElementById('ai-model-scoring')?.value || null,
                    model_rename: document.getElementById('ai-model-rename')?.value || null,
                    model_analysis: document.getElementById('ai-model-analysis')?.value || null,
                    timeout: 120
                };
            }

            // Handle YGG passkey
            if (serviceName === 'ygg') {
                const passkey = document.getElementById('ygg-passkey')?.value;
                if (passkey) {
                    config.extra_config = { passkey };
                }
            }

            return config;
        }

        async function saveAllServicesConfig() {
            const token = localStorage.getItem('access_token');
            const services = ['plex', 'qbittorrent', 'ai', 'ygg', 'tmdb', 'discord'];

            let successCount = 0;
            let errorCount = 0;

            for (const serviceName of services) {
                const config = getServiceConfigFromForm(serviceName);

                // Skip if no URL/API key is set
                if (!config.url && !config.api_key && !config.token) {
                    continue;
                }

                try {
                    const response = await fetch(`${API_BASE}/services/${serviceName}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(config)
                    });

                    if (response.ok) {
                        successCount++;
                    } else {
                        errorCount++;
                    }
                } catch (e) {
                    console.error(`Error saving ${serviceName}:`, e);
                    errorCount++;
                }
            }

            if (successCount > 0) {
                showToast(`${successCount} service(s) sauvegardé(s)`, 'success');
            }
            if (errorCount > 0) {
                showToast(`${errorCount} erreur(s) de sauvegarde`, 'danger');
            }

            // Refresh health
            await refreshAllServicesHealth();
        }

        async function migrateServicesFromEnv() {
            const token = localStorage.getItem('access_token');

            try {
                const response = await fetch(`${API_BASE}/services/migrate-env`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const result = await response.json();
                    showToast(result.message, 'success');
                    await loadServicesConfig();
                    await refreshAllServicesHealth();
                } else {
                    showToast('Erreur de migration', 'danger');
                }
            } catch (e) {
                console.error('Error migrating services:', e);
                showToast('Erreur réseau', 'danger');
            }
        }

        function togglePasswordVisibility(inputId) {
            const input = document.getElementById(inputId);
            const icon = input.nextElementSibling?.querySelector('i') || input.parentElement.querySelector('button i');

            if (input.type === 'password') {
                input.type = 'text';
                if (icon) icon.className = 'bi bi-eye-slash';
            } else {
                input.type = 'password';
                if (icon) icon.className = 'bi bi-eye';
            }
        }

        // Load services when tab is shown
        document.querySelector('[data-bs-target="#servicesTab"]')?.addEventListener('shown.bs.tab', () => {
            loadServicesConfig();
            refreshAllServicesHealth();
        });

        // =========================================================================
        // MONITORING TAB
        // =========================================================================

        let monitoredSeriesData = [];
        let calendarData = [];

        // Load monitoring data when tab is shown
        document.querySelector('[data-bs-target="#monitoringTab"]')?.addEventListener('shown.bs.tab', () => {
            loadMonitoringData();
        });

        async function loadMonitoringData() {
            await Promise.all([
                loadMonitoringStats(),
                refreshMonitoredSeries(),
                refreshPendingApprovals()
            ]);
        }

        async function loadMonitoringStats() {
            try {
                const response = await fetch(`${API_BASE}/monitoring/stats`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` }
                });
                if (response.ok) {
                    const stats = await response.json();
                    document.getElementById('monitoringTotalSeries').textContent = stats.total_series || 0;
                    document.getElementById('monitoringActiveSeries').textContent = stats.by_status?.active || 0;
                    document.getElementById('monitoringPendingApprovals').textContent = stats.pending_approvals || 0;

                    // Update badges
                    const badge = document.getElementById('pendingApprovalsBadge');
                    const pillBadge = document.getElementById('pendingApprovalsPillBadge');
                    if (stats.pending_approvals > 0) {
                        badge.textContent = stats.pending_approvals;
                        badge.style.display = 'inline';
                        pillBadge.textContent = stats.pending_approvals;
                        pillBadge.style.display = 'inline';
                    } else {
                        badge.style.display = 'none';
                        pillBadge.style.display = 'none';
                    }
                }
            } catch (e) {
                console.error('Error loading monitoring stats:', e);
            }
        }

        async function refreshMonitoredSeries() {
            const tbody = document.getElementById('monitoredSeriesBody');
            tbody.innerHTML = `<tr><td colspan="7" class="text-center py-4">
                <div class="spinner-border spinner-border-sm text-primary"></div>
                <span class="ms-2 text-muted">Chargement...</span>
            </td></tr>`;

            try {
                const response = await fetch(`${API_BASE}/monitoring/series`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` }
                });
                if (response.ok) {
                    monitoredSeriesData = await response.json();
                    renderMonitoredSeries();
                }
            } catch (e) {
                console.error('Error loading monitored series:', e);
                tbody.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-danger">Erreur de chargement</td></tr>`;
            }
        }

        function renderMonitoredSeries() {
            const tbody = document.getElementById('monitoredSeriesBody');

            if (!monitoredSeriesData.length) {
                tbody.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-muted">
                    <i class="bi bi-tv fs-1 mb-2 d-block"></i>
                    Aucune série suivie. Cliquez sur "Ajouter" pour commencer.
                </td></tr>`;
                return;
            }

            tbody.innerHTML = monitoredSeriesData.map(series => {
                const statusBadge = getSeriesStatusBadge(series.status);
                const monitorTypeLabel = getMonitorTypeLabel(series.monitor_type);

                return `<tr>
                    <td>
                        ${series.poster_url
                            ? `<img src="${series.poster_url}" alt="${series.title}" style="width:40px; height:60px; object-fit:cover; border-radius:4px;">`
                            : `<div class="bg-secondary rounded d-flex align-items-center justify-content-center" style="width:40px; height:60px;"><i class="bi bi-film"></i></div>`
                        }
                    </td>
                    <td>
                        <strong>${series.title}</strong>
                        ${series.year ? `<span class="text-muted">(${series.year})</span>` : ''}
                        <br>
                        <small class="text-muted">${monitorTypeLabel}</small>
                    </td>
                    <td><span class="badge bg-${series.media_type === 'anime' ? 'info' : 'secondary'}">${series.media_type}</span></td>
                    <td><span class="badge bg-dark">${series.quality_preference}</span></td>
                    <td><span class="badge bg-dark">${series.audio_preference.toUpperCase()}</span></td>
                    <td>${statusBadge}</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            ${series.status === 'active'
                                ? `<button class="btn btn-outline-warning" onclick="pauseSeries(${series.id})" title="Mettre en pause"><i class="bi bi-pause-fill"></i></button>`
                                : `<button class="btn btn-outline-success" onclick="resumeSeries(${series.id})" title="Reprendre"><i class="bi bi-play-fill"></i></button>`
                            }
                            <button class="btn btn-outline-primary" onclick="refreshSeriesSchedule(${series.id})" title="Rafraîchir calendrier"><i class="bi bi-arrow-clockwise"></i></button>
                            <button class="btn btn-outline-danger" onclick="removeSeries(${series.id})" title="Supprimer"><i class="bi bi-trash"></i></button>
                        </div>
                    </td>
                </tr>`;
            }).join('');
        }

        function getSeriesStatusBadge(status) {
            const badges = {
                'active': '<span class="badge bg-success">Active</span>',
                'paused': '<span class="badge bg-warning">En pause</span>',
                'ended': '<span class="badge bg-secondary">Terminée</span>'
            };
            return badges[status] || `<span class="badge bg-secondary">${status}</span>`;
        }

        function getMonitorTypeLabel(type) {
            const labels = {
                'new_episodes': 'Nouveaux épisodes',
                'vostfr_upgrade': 'Upgrade VOSTFR',
                'both': 'Nouveaux + Upgrade'
            };
            return labels[type] || type;
        }

        async function pauseSeries(seriesId) {
            try {
                const response = await fetch(`${API_BASE}/monitoring/series/${seriesId}/pause`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` }
                });
                if (response.ok) {
                    showToast('Série mise en pause', 'success');
                    refreshMonitoredSeries();
                }
            } catch (e) {
                showToast('Erreur lors de la mise en pause', 'danger');
            }
        }

        async function resumeSeries(seriesId) {
            try {
                const response = await fetch(`${API_BASE}/monitoring/series/${seriesId}/resume`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` }
                });
                if (response.ok) {
                    showToast('Monitoring repris', 'success');
                    refreshMonitoredSeries();
                }
            } catch (e) {
                showToast('Erreur lors de la reprise', 'danger');
            }
        }

        async function refreshSeriesSchedule(seriesId) {
            try {
                const response = await fetch(`${API_BASE}/monitoring/series/${seriesId}/refresh`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` }
                });
                if (response.ok) {
                    const result = await response.json();
                    showToast(result.message, 'success');
                }
            } catch (e) {
                showToast('Erreur lors du rafraîchissement', 'danger');
            }
        }

        async function removeSeries(seriesId) {
            if (!confirm('Supprimer cette série du monitoring ?')) return;

            try {
                const response = await fetch(`${API_BASE}/monitoring/series/${seriesId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` }
                });
                if (response.ok) {
                    showToast('Série retirée du monitoring', 'success');
                    refreshMonitoredSeries();
                    loadMonitoringStats();
                }
            } catch (e) {
                showToast('Erreur lors de la suppression', 'danger');
            }
        }

        // Calendar
        async function refreshCalendar() {
            const container = document.getElementById('calendarContent');
            const daysAhead = parseInt(document.getElementById('calendarDaysFilter').value) || 14;

            container.innerHTML = `<div class="text-center py-4">
                <div class="spinner-border spinner-border-sm text-primary"></div>
                <span class="ms-2 text-muted">Chargement du calendrier...</span>
            </div>`;

            try {
                const response = await fetch(`${API_BASE}/monitoring/calendar?days_back=7&days_ahead=${daysAhead}`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` }
                });
                if (response.ok) {
                    calendarData = await response.json();
                    renderCalendar();

                    // Update upcoming count
                    const upcoming = calendarData.filter(e => !e.is_aired).length;
                    document.getElementById('monitoringUpcomingEpisodes').textContent = upcoming;
                }
            } catch (e) {
                console.error('Error loading calendar:', e);
                container.innerHTML = `<div class="text-center py-4 text-danger">Erreur de chargement</div>`;
            }
        }

        function renderCalendar() {
            const container = document.getElementById('calendarContent');

            if (!calendarData.length) {
                container.innerHTML = `<div class="text-center py-4 text-muted">
                    <i class="bi bi-calendar-x fs-1 mb-2 d-block"></i>
                    Aucun épisode dans cette période
                </div>`;
                return;
            }

            // Group by date
            const grouped = {};
            calendarData.forEach(ep => {
                const date = ep.air_date.split('T')[0];
                if (!grouped[date]) grouped[date] = [];
                grouped[date].push(ep);
            });

            let html = '<div class="row g-3">';

            Object.keys(grouped).sort().forEach(date => {
                const dateObj = new Date(date);
                const today = new Date().toISOString().split('T')[0];
                const isToday = date === today;
                const isPast = date < today;

                html += `<div class="col-12">
                    <div class="p-3 rounded ${isToday ? 'bg-primary bg-opacity-25' : isPast ? 'bg-dark' : 'bg-secondary bg-opacity-10'}">
                        <h6 class="mb-2 ${isToday ? 'text-primary' : ''}"">
                            <i class="bi bi-calendar-event me-2"></i>
                            ${dateObj.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' })}
                            ${isToday ? '<span class="badge bg-primary ms-2">Aujourd\'hui</span>' : ''}
                        </h6>
                        <div class="d-flex flex-wrap gap-2">`;

                grouped[date].forEach(ep => {
                    const statusColor = getEpisodeStatusColor(ep.status);
                    html += `<div class="d-flex align-items-center gap-2 p-2 rounded bg-dark" style="min-width:250px;">
                        ${ep.series_poster
                            ? `<img src="${ep.series_poster}" style="width:30px; height:45px; object-fit:cover; border-radius:4px;">`
                            : '<div class="bg-secondary rounded" style="width:30px; height:45px;"></div>'
                        }
                        <div class="flex-grow-1">
                            <div class="fw-medium small">${ep.series_title}</div>
                            <div class="text-muted small">${ep.episode_code}${ep.episode_title ? ' - ' + ep.episode_title : ''}</div>
                        </div>
                        <span class="badge bg-${statusColor}">${ep.status}</span>
                    </div>`;
                });

                html += `</div></div></div>`;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        function getEpisodeStatusColor(status) {
            const colors = {
                'upcoming': 'secondary',
                'aired': 'info',
                'searching': 'warning',
                'found': 'success',
                'pending_approval': 'warning',
                'downloading': 'primary',
                'completed': 'success',
                'not_found': 'danger',
                'skipped': 'dark'
            };
            return colors[status] || 'secondary';
        }

        // Pending Approvals
        async function refreshPendingApprovals() {
            const container = document.getElementById('pendingApprovalsContent');

            try {
                const response = await fetch(`${API_BASE}/monitoring/episodes/pending`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` }
                });
                if (response.ok) {
                    const episodes = await response.json();
                    renderPendingApprovals(episodes);
                }
            } catch (e) {
                console.error('Error loading pending approvals:', e);
            }
        }

        function renderPendingApprovals(episodes) {
            const container = document.getElementById('pendingApprovalsContent');

            if (!episodes.length) {
                container.innerHTML = `<div class="text-center py-4 text-muted">
                    <i class="bi bi-check-circle fs-1 mb-2 d-block"></i>
                    Aucun épisode en attente d'approbation
                </div>`;
                return;
            }

            container.innerHTML = `<div class="table-responsive">
                <table class="table table-dark-custom">
                    <thead>
                        <tr>
                            <th>Série</th>
                            <th>Épisode</th>
                            <th>Torrent trouvé</th>
                            <th>Qualité</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${episodes.map(ep => `<tr>
                            <td>Série #${ep.monitored_series_id}</td>
                            <td><span class="badge bg-info">${ep.episode_code}</span></td>
                            <td>
                                <small class="text-break">${ep.found_torrent_name || 'N/A'}</small>
                                <br>
                                <small class="text-muted">${ep.found_torrent_size || ''} - ${ep.found_torrent_seeders || 0} seeders</small>
                            </td>
                            <td>${ep.found_torrent_quality || 'N/A'}</td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-success" onclick="approveEpisode(${ep.id})" title="Approuver">
                                        <i class="bi bi-check-lg"></i>
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="skipEpisode(${ep.id})" title="Ignorer">
                                        <i class="bi bi-skip-forward"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>`).join('')}
                    </tbody>
                </table>
            </div>`;
        }

        async function approveEpisode(episodeId) {
            try {
                const response = await fetch(`${API_BASE}/monitoring/episodes/${episodeId}/approve`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` }
                });
                if (response.ok) {
                    showToast('Épisode approuvé, téléchargement lancé', 'success');
                    refreshPendingApprovals();
                    loadMonitoringStats();
                }
            } catch (e) {
                showToast('Erreur lors de l\'approbation', 'danger');
            }
        }

        async function skipEpisode(episodeId) {
            try {
                const response = await fetch(`${API_BASE}/monitoring/episodes/${episodeId}/skip`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` }
                });
                if (response.ok) {
                    showToast('Épisode ignoré', 'info');
                    refreshPendingApprovals();
                }
            } catch (e) {
                showToast('Erreur', 'danger');
            }
        }

        // Add Series Modal
        function showAddSeriesModal() {
            document.getElementById('seriesSearchInput').value = '';
            document.getElementById('seriesSearchResults').style.display = 'none';
            document.getElementById('selectedSeriesInfo').style.display = 'none';
            document.getElementById('addSeriesBtn').disabled = true;

            const modal = new bootstrap.Modal(document.getElementById('addSeriesModal'));
            modal.show();
        }

        async function searchSeriesToAdd() {
            const query = document.getElementById('seriesSearchInput').value.trim();
            if (!query) return;

            const resultsContainer = document.getElementById('seriesSearchResultsList');
            document.getElementById('seriesSearchResults').style.display = 'block';
            resultsContainer.innerHTML = `<div class="col-12 text-center py-3">
                <div class="spinner-border spinner-border-sm text-primary"></div>
            </div>`;

            try {
                // Search both series and anime
                const response = await fetch(`${API_BASE}/search?query=${encodeURIComponent(query)}&media_type=all`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` }
                });

                if (response.ok) {
                    const results = await response.json();
                    // Filter to only series and anime
                    const seriesResults = results.filter(r => r.media_type === 'series' || r.media_type === 'anime');

                    if (!seriesResults.length) {
                        resultsContainer.innerHTML = `<div class="col-12 text-center text-muted py-3">Aucun résultat</div>`;
                        return;
                    }

                    resultsContainer.innerHTML = seriesResults.slice(0, 10).map(result => `
                        <div class="col-6 col-md-4 col-lg-3">
                            <div class="p-2 rounded bg-dark cursor-pointer border border-transparent hover-border-primary"
                                 onclick="selectSeriesResult(${JSON.stringify(result).replace(/"/g, '&quot;')})"
                                 style="cursor:pointer;">
                                ${result.poster_url
                                    ? `<img src="${result.poster_url}" class="w-100 rounded mb-2" style="aspect-ratio:2/3; object-fit:cover;">`
                                    : `<div class="w-100 bg-secondary rounded mb-2 d-flex align-items-center justify-content-center" style="aspect-ratio:2/3;"><i class="bi bi-film fs-3"></i></div>`
                                }
                                <div class="small fw-medium text-truncate">${result.title}</div>
                                <div class="small text-muted">${result.year || ''} - ${result.media_type}</div>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (e) {
                console.error('Search error:', e);
                resultsContainer.innerHTML = `<div class="col-12 text-center text-danger py-3">Erreur de recherche</div>`;
            }
        }

        function selectSeriesResult(result) {
            document.getElementById('selectedSeriesInfo').style.display = 'block';
            document.getElementById('selectedSeriesPoster').src = result.poster_url || '';
            document.getElementById('selectedSeriesTitle').textContent = result.title;
            document.getElementById('selectedSeriesYear').textContent = result.year ? `(${result.year})` : '';

            // Set hidden fields based on source
            if (result.source === 'anilist') {
                document.getElementById('selectedSeriesAnilistId').value = result.id;
                document.getElementById('selectedSeriesTmdbId').value = '';
            } else {
                document.getElementById('selectedSeriesTmdbId').value = result.id;
                document.getElementById('selectedSeriesAnilistId').value = '';
            }

            document.getElementById('selectedSeriesMediaType').value = result.media_type;
            document.getElementById('selectedSeriesPosterUrl').value = result.poster_url || '';

            document.getElementById('addSeriesBtn').disabled = false;
        }

        async function addSeriesToMonitoring() {
            const title = document.getElementById('selectedSeriesTitle').textContent;
            const tmdbId = document.getElementById('selectedSeriesTmdbId').value || null;
            const anilistId = document.getElementById('selectedSeriesAnilistId').value || null;
            const mediaType = document.getElementById('selectedSeriesMediaType').value;
            const posterUrl = document.getElementById('selectedSeriesPosterUrl').value;
            const yearText = document.getElementById('selectedSeriesYear').textContent;
            const year = yearText ? parseInt(yearText.replace(/[()]/g, '')) : null;

            const data = {
                tmdb_id: tmdbId,
                anilist_id: anilistId,
                title: title,
                year: year,
                media_type: mediaType,
                poster_url: posterUrl,
                monitor_type: document.getElementById('addSeriesMonitorType').value,
                quality_preference: document.getElementById('addSeriesQuality').value,
                audio_preference: document.getElementById('addSeriesAudio').value
            };

            try {
                const response = await fetch(`${API_BASE}/monitoring/series`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    showToast(`${title} ajouté au monitoring`, 'success');
                    bootstrap.Modal.getInstance(document.getElementById('addSeriesModal')).hide();
                    refreshMonitoredSeries();
                    loadMonitoringStats();
                } else {
                    const err = await response.json();
                    showToast(err.detail || 'Erreur', 'danger');
                }
            } catch (e) {
                showToast('Erreur lors de l\'ajout', 'danger');
            }
        }

        // Manual Tasks
        async function triggerEpisodeCheck() {
            showToast('Recherche des épisodes en cours...', 'info');
            try {
                const response = await fetch(`${API_BASE}/monitoring/tasks/check-episodes`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` }
                });
                if (response.ok) {
                    const result = await response.json();
                    showToast(`Vérification terminée: ${result.results?.episodes_found || 0} épisodes trouvés`, 'success');
                    loadMonitoringData();
                }
            } catch (e) {
                showToast('Erreur lors de la vérification', 'danger');
            }
        }

        async function triggerAiredUpdate() {
            try {
                const response = await fetch(`${API_BASE}/monitoring/tasks/update-aired`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` }
                });
                if (response.ok) {
                    const result = await response.json();
                    showToast(result.message, 'success');
                }
            } catch (e) {
                showToast('Erreur', 'danger');
            }
        }

        // Listen for calendar filter change
        document.getElementById('calendarDaysFilter')?.addEventListener('change', refreshCalendar);

        // Listen for calendar sub-tab shown
        document.querySelector('[data-bs-target="#calendarPane"]')?.addEventListener('shown.bs.tab', refreshCalendar);

        // =========================================================================
        // ANALYSIS TAB FUNCTIONS
        // =========================================================================

        let currentAnalysisRunId = null;
        let analysisPollingInterval = null;
        let allAnalysisResults = [];

        // Load analysis data when tab is shown
        document.querySelector('[data-bs-target="#analysisTab"]')?.addEventListener('shown.bs.tab', () => {
            loadAnalysisSummary();
            loadAnalysisResults();
            loadAnalysisHistory();
        });

        async function loadAnalysisSummary() {
            try {
                const response = await fetch(`${API_BASE}/analysis/summary`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` }
                });
                if (response.ok) {
                    const summary = await response.json();
                    document.getElementById('analysisHighCount').textContent = summary.by_severity?.high || 0;
                    document.getElementById('analysisMediumCount').textContent = summary.by_severity?.medium || 0;
                    document.getElementById('analysisLowCount').textContent = summary.by_severity?.low || 0;
                    document.getElementById('analysisTotalCount').textContent = summary.total_issues || 0;

                    // Update badge
                    const badge = document.getElementById('analysisIssuesBadge');
                    const total = summary.total_issues || 0;
                    if (total > 0) {
                        badge.textContent = total;
                        badge.style.display = 'inline';
                    } else {
                        badge.style.display = 'none';
                    }
                }
            } catch (e) {
                console.error('Erreur chargement résumé analyse:', e);
            }
        }

        async function loadAnalysisResults() {
            try {
                const analysisType = document.getElementById('filterAnalysisType')?.value || '';
                const severity = document.getElementById('filterSeverity')?.value || '';

                let url = `${API_BASE}/analysis/results?limit=100`;
                if (analysisType) url += `&analysis_type=${analysisType}`;
                if (severity) url += `&severity=${severity}`;

                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` }
                });

                if (response.ok) {
                    allAnalysisResults = await response.json();
                    filterAnalysisResults();
                }
            } catch (e) {
                console.error('Erreur chargement résultats analyse:', e);
            }
        }

        function filterAnalysisResults() {
            const showDismissed = document.getElementById('showDismissed')?.checked || false;
            const analysisType = document.getElementById('filterAnalysisType')?.value || '';
            const severity = document.getElementById('filterSeverity')?.value || '';

            let filtered = allAnalysisResults;

            if (!showDismissed) {
                filtered = filtered.filter(r => !r.is_dismissed);
            }
            if (analysisType) {
                filtered = filtered.filter(r => r.analysis_type === analysisType);
            }
            if (severity) {
                filtered = filtered.filter(r => r.severity === severity);
            }

            renderAnalysisResults(filtered);
        }

        function renderAnalysisResults(results) {
            const tbody = document.getElementById('analysisResultsBody');
            if (!tbody) return;

            if (results.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-muted py-4">
                            <i class="bi bi-check-circle display-4"></i>
                            <p class="mt-2 mb-0">Aucun problème détecté ou tous les problèmes ont été traités.</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = results.map(r => {
                const severityBadge = getSeverityBadge(r.severity);
                const typeBadge = getAnalysisTypeBadge(r.analysis_type);
                const posterUrl = r.poster_url || 'https://via.placeholder.com/45x67?text=?';
                const dismissedClass = r.is_dismissed ? 'opacity-50' : '';

                return `
                    <tr class="${dismissedClass}">
                        <td>
                            <img src="${posterUrl}" alt="${r.title}" class="rounded" style="width:45px;height:67px;object-fit:cover;">
                        </td>
                        <td>
                            <strong>${r.title}</strong>
                            ${r.year ? `<small class="text-muted">(${r.year})</small>` : ''}
                            <br><small class="text-muted">${r.media_type}</small>
                        </td>
                        <td>${typeBadge}</td>
                        <td>
                            <small>${r.issue_description}</small>
                            ${r.ai_reasoning ? `<br><small class="text-info"><i class="bi bi-robot"></i> ${r.ai_reasoning}</small>` : ''}
                        </td>
                        <td>${severityBadge}</td>
                        <td><small>${r.recommended_action}</small></td>
                        <td>
                            ${r.is_dismissed ?
                                `<span class="badge bg-secondary">Ignoré</span>` :
                                `<div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-success" onclick="actionAnalysisResult(${r.id})" title="Créer une demande">
                                        <i class="bi bi-plus-circle"></i>
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="dismissAnalysisResult(${r.id})" title="Ignorer">
                                        <i class="bi bi-x-circle"></i>
                                    </button>
                                </div>`
                            }
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function getSeverityBadge(severity) {
            const badges = {
                'high': '<span class="badge bg-danger">Haute</span>',
                'medium': '<span class="badge bg-warning text-dark">Moyenne</span>',
                'low': '<span class="badge bg-success">Basse</span>'
            };
            return badges[severity] || `<span class="badge bg-secondary">${severity}</span>`;
        }

        function getAnalysisTypeBadge(type) {
            const types = {
                'missing_collection': '<span class="badge bg-info">Collection</span>',
                'low_quality': '<span class="badge bg-warning text-dark">Qualité</span>',
                'bad_codec': '<span class="badge bg-secondary">Codec</span>',
                'vostfr_upgradable': '<span class="badge bg-primary">VOSTFR</span>',
                'missing_episodes': '<span class="badge bg-danger">Épisodes</span>'
            };
            return types[type] || `<span class="badge bg-secondary">${type}</span>`;
        }

        async function loadAnalysisHistory() {
            try {
                const response = await fetch(`${API_BASE}/analysis/runs?limit=10`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` }
                });

                if (response.ok) {
                    const runs = await response.json();
                    renderAnalysisHistory(runs);
                }
            } catch (e) {
                console.error('Erreur chargement historique analyses:', e);
            }
        }

        function renderAnalysisHistory(runs) {
            const tbody = document.getElementById('analysisHistoryBody');
            if (!tbody) return;

            if (runs.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-muted py-4">
                            Aucune analyse effectuée
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = runs.map(run => {
                const statusBadge = getRunStatusBadge(run.status);
                const date = run.started_at ? new Date(run.started_at).toLocaleString('fr-FR') : '-';
                const duration = run.duration_seconds ? `${run.duration_seconds}s` : '-';
                const types = run.analysis_types ? run.analysis_types.join(', ') : 'Tous';

                return `
                    <tr>
                        <td>${date}</td>
                        <td>${statusBadge}</td>
                        <td><small>${types}</small></td>
                        <td>${run.items_analyzed}/${run.total_items_to_analyze}</td>
                        <td>
                            <span class="badge bg-info">${run.issues_found}</span>
                        </td>
                        <td>${duration}</td>
                        <td>
                            <button class="btn btn-outline-primary btn-sm" onclick="viewAnalysisRun('${run.id}')">
                                <i class="bi bi-eye"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function getRunStatusBadge(status) {
            const badges = {
                'running': '<span class="badge bg-primary"><i class="bi bi-arrow-repeat spin me-1"></i>En cours</span>',
                'completed': '<span class="badge bg-success">Terminé</span>',
                'failed': '<span class="badge bg-danger">Échec</span>',
                'cancelled': '<span class="badge bg-secondary">Annulé</span>'
            };
            return badges[status] || `<span class="badge bg-secondary">${status}</span>`;
        }

        async function startAnalysis() {
            const btn = document.getElementById('startAnalysisBtn');
            const progressDiv = document.getElementById('analysisProgress');

            // Get selected analysis types
            const analysisTypesSelect = document.getElementById('analysisTypes');
            const analysisTypes = Array.from(analysisTypesSelect.selectedOptions).map(o => o.value);

            // Get selected media types
            const mediaTypesSelect = document.getElementById('analysisMediaTypes');
            const mediaTypes = Array.from(mediaTypesSelect.selectedOptions).map(o => o.value);

            if (analysisTypes.length === 0) {
                showToast('Sélectionnez au moins un type d\'analyse', 'warning');
                return;
            }

            btn.disabled = true;
            progressDiv.style.display = 'block';

            try {
                const response = await fetch(`${API_BASE}/analysis/run`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    },
                    body: JSON.stringify({
                        analysis_types: analysisTypes,
                        media_types: mediaTypes
                    })
                });

                if (response.ok) {
                    const run = await response.json();
                    currentAnalysisRunId = run.id;
                    showToast('Analyse démarrée', 'success');
                    startAnalysisPolling();
                } else {
                    const error = await response.json();
                    showToast(error.detail || 'Erreur lors du lancement', 'danger');
                    btn.disabled = false;
                    progressDiv.style.display = 'none';
                }
            } catch (e) {
                showToast('Erreur réseau', 'danger');
                btn.disabled = false;
                progressDiv.style.display = 'none';
            }
        }

        function startAnalysisPolling() {
            if (analysisPollingInterval) {
                clearInterval(analysisPollingInterval);
            }

            analysisPollingInterval = setInterval(async () => {
                if (!currentAnalysisRunId) {
                    clearInterval(analysisPollingInterval);
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE}/analysis/runs/${currentAnalysisRunId}`, {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` }
                    });

                    if (response.ok) {
                        const run = await response.json();
                        updateAnalysisProgress(run);

                        if (run.status === 'completed' || run.status === 'failed' || run.status === 'cancelled') {
                            clearInterval(analysisPollingInterval);
                            analysisPollingInterval = null;
                            currentAnalysisRunId = null;

                            document.getElementById('startAnalysisBtn').disabled = false;
                            setTimeout(() => {
                                document.getElementById('analysisProgress').style.display = 'none';
                            }, 2000);

                            // Reload data
                            loadAnalysisSummary();
                            loadAnalysisResults();
                            loadAnalysisHistory();

                            if (run.status === 'completed') {
                                showToast(`Analyse terminée: ${run.issues_found} problèmes détectés`, 'success');
                            } else if (run.status === 'failed') {
                                showToast(`Analyse échouée: ${run.error_message}`, 'danger');
                            }
                        }
                    }
                } catch (e) {
                    console.error('Erreur polling analyse:', e);
                }
            }, 2000);
        }

        function updateAnalysisProgress(run) {
            const progressBar = document.getElementById('analysisProgressBar');
            const phaseText = document.getElementById('analysisPhase');

            if (progressBar) {
                progressBar.style.width = `${run.progress_percent}%`;
                progressBar.textContent = `${run.progress_percent}%`;
            }

            if (phaseText) {
                phaseText.textContent = run.current_phase || run.status_message || 'En cours...';
            }
        }

        async function dismissAnalysisResult(resultId) {
            if (!confirm('Ignorer ce résultat ?')) return;

            try {
                const response = await fetch(`${API_BASE}/analysis/results/${resultId}/dismiss`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    },
                    body: JSON.stringify({})
                });

                if (response.ok) {
                    showToast('Résultat ignoré', 'success');
                    loadAnalysisSummary();
                    loadAnalysisResults();
                } else {
                    showToast('Erreur', 'danger');
                }
            } catch (e) {
                showToast('Erreur réseau', 'danger');
            }
        }

        async function actionAnalysisResult(resultId) {
            // Find the result to get details
            const result = allAnalysisResults.find(r => r.id === resultId);
            if (!result) {
                showToast('Résultat non trouvé', 'danger');
                return;
            }

            // For now, just show a message - in a full implementation,
            // this would open a modal to create a media request
            const confirmMsg = `Créer une demande pour "${result.title}" ?\n\nAction recommandée: ${result.recommended_action}`;
            if (!confirm(confirmMsg)) return;

            // TODO: Open create request modal with pre-filled data
            showToast('Fonctionnalité à implémenter: création de demande depuis l\'analyse', 'info');
        }

        async function viewAnalysisRun(runId) {
            try {
                const response = await fetch(`${API_BASE}/analysis/runs/${runId}/results`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` }
                });

                if (response.ok) {
                    const results = await response.json();
                    allAnalysisResults = results;
                    filterAnalysisResults();
                    showToast(`Affichage des ${results.length} résultats de cette analyse`, 'info');
                }
            } catch (e) {
                showToast('Erreur chargement', 'danger');
            }
        }
    </script>
</body>

</html>