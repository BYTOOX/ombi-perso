<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plex Kiosk</title>
    <meta name="description" content="Demandez vos films, s√©ries et anim√©s pr√©f√©r√©s">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Styles -->
    <link rel="stylesheet" href="/static/css/styles.css">
    
    <!-- Alpine.js -->
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
</head>
<body x-data="app()" x-init="init()" class="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900">
    
    <!-- Navigation -->
    <nav class="glass-card sticky top-0 z-50 border-b border-white/10">
        <div class="container mx-auto px-4 py-3">
            <div class="flex items-center justify-between">
                <!-- Logo -->
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-amber-500 to-orange-600 flex items-center justify-center">
                        <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path>
                        </svg>
                    </div>
                    <h1 class="text-xl font-bold text-white" x-text="appName"></h1>
                </div>
                
                <!-- Search Bar -->
                <div class="flex-1 max-w-xl mx-8">
                    <div class="relative">
                        <input 
                            type="text" 
                            x-model="searchQuery"
                            @input.debounce.300ms="search()"
                            @keydown.enter="search()"
                            placeholder="Rechercher un film, une s√©rie, un anim√©..."
                            class="w-full px-4 py-2.5 pl-10 bg-white/5 border border-white/10 rounded-xl text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-amber-500/50 focus:border-amber-500/50 transition-all"
                        >
                        <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                        <div x-show="searching" class="absolute right-3 top-1/2 -translate-y-1/2">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>
                
                <!-- User Menu -->
                <div class="flex items-center gap-4">
                    <template x-if="!user">
                        <button @click="showLoginModal = true" class="btn-primary">
                            Connexion
                        </button>
                    </template>
                    <template x-if="user">
                        <div class="flex items-center gap-3">
                            <div class="text-right">
                                <div class="text-white font-medium" x-text="user.username"></div>
                                <div class="text-xs text-slate-400">
                                    <span x-text="stats.requests_remaining"></span> demandes restantes
                                </div>
                            </div>
                            <div class="relative" x-data="{open: false}">
                                <button @click="open = !open" class="w-10 h-10 rounded-full bg-gradient-to-br from-amber-500 to-orange-600 flex items-center justify-center text-white font-bold">
                                    <span x-text="user.username.charAt(0).toUpperCase()"></span>
                                </button>
                                <div x-show="open" @click.away="open = false" 
                                     x-transition
                                     class="absolute right-0 mt-2 w-48 glass-card rounded-xl shadow-xl py-2 z-50">
                                    <a href="#" @click="view = 'requests'" class="block px-4 py-2 text-slate-300 hover:bg-white/10">Mes demandes</a>
                                    <template x-if="user.role === 'admin'">
                                        <a href="#" @click="view = 'admin'" class="block px-4 py-2 text-slate-300 hover:bg-white/10">Administration</a>
                                    </template>
                                    <hr class="my-2 border-white/10">
                                    <button @click="logout()" class="w-full text-left px-4 py-2 text-red-400 hover:bg-white/10">D√©connexion</button>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </nav>
    
    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        
        <!-- Filters -->
        <div class="flex items-center gap-4 mb-8">
            <div class="flex gap-2 p-1 bg-white/5 rounded-xl">
                <button @click="mediaType = 'all'" 
                        :class="mediaType === 'all' ? 'bg-amber-500 text-white' : 'text-slate-400 hover:text-white'"
                        class="px-4 py-2 rounded-lg font-medium transition-all">
                    Tout
                </button>
                <button @click="mediaType = 'movie'" 
                        :class="mediaType === 'movie' ? 'bg-amber-500 text-white' : 'text-slate-400 hover:text-white'"
                        class="px-4 py-2 rounded-lg font-medium transition-all">
                    Films
                </button>
                <button @click="mediaType = 'series'" 
                        :class="mediaType === 'series' ? 'bg-amber-500 text-white' : 'text-slate-400 hover:text-white'"
                        class="px-4 py-2 rounded-lg font-medium transition-all">
                    S√©ries
                </button>
                <button @click="mediaType = 'anime'" 
                        :class="mediaType === 'anime' ? 'bg-amber-500 text-white' : 'text-slate-400 hover:text-white'"
                        class="px-4 py-2 rounded-lg font-medium transition-all">
                    Anim√©s
                </button>
            </div>
            
            <template x-if="searchResults.length > 0">
                <div class="text-slate-400">
                    <span x-text="searchResults.length"></span> r√©sultats
                </div>
            </template>
        </div>
        
        <!-- Search Results Grid -->
        <div x-show="searchResults.length > 0" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
            <template x-for="media in searchResults" :key="media.id + media.source">
                <div class="media-card group" @click="openMediaModal(media)">
                    <!-- Poster -->
                    <div class="relative aspect-[2/3] rounded-xl overflow-hidden mb-3">
                        <img :src="media.poster_url || '/static/img/no-poster.png'" 
                             :alt="media.title"
                             class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300">
                        
                        <!-- Overlay -->
                        <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity">
                            <div class="absolute bottom-0 left-0 right-0 p-4">
                                <div class="flex items-center gap-2 text-sm text-white/80">
                                    <span x-text="media.year || '‚Äî'"></span>
                                    <span>‚Ä¢</span>
                                    <span x-text="getMediaTypeLabel(media.media_type)"></span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Rating Badge -->
                        <div x-show="media.rating" class="absolute top-2 right-2 px-2 py-1 rounded-lg bg-black/60 backdrop-blur text-white text-sm font-medium">
                            ‚≠ê <span x-text="media.rating?.toFixed(1)"></span>
                        </div>
                        
                        <!-- Already Available Badge -->
                        <div x-show="media.already_available" class="absolute top-2 left-2 px-2 py-1 rounded-lg bg-green-500/80 backdrop-blur text-white text-xs font-medium">
                            ‚úì Disponible
                        </div>
                    </div>
                    
                    <!-- Title -->
                    <h3 class="text-white font-medium line-clamp-2 group-hover:text-amber-400 transition-colors" x-text="media.title"></h3>
                </div>
            </template>
        </div>
        
        <!-- Empty State -->
        <div x-show="searchResults.length === 0 && !searching && searchQuery.length > 0" class="text-center py-20">
            <div class="text-6xl mb-4">üîç</div>
            <h2 class="text-2xl font-bold text-white mb-2">Aucun r√©sultat</h2>
            <p class="text-slate-400">Essayez avec d'autres termes de recherche</p>
        </div>
        
        <!-- Welcome State -->
        <div x-show="searchResults.length === 0 && searchQuery.length === 0" class="text-center py-20">
            <div class="text-6xl mb-4">üé¨</div>
            <h2 class="text-3xl font-bold text-white mb-2">Bienvenue sur Plex Kiosk</h2>
            <p class="text-slate-400 mb-8">Recherchez et demandez vos films, s√©ries et anim√©s pr√©f√©r√©s</p>
            <div class="flex justify-center gap-4">
                <button class="btn-secondary" @click="searchQuery = 'Dune'; search()">Dune</button>
                <button class="btn-secondary" @click="searchQuery = 'Attack on Titan'; search()">Attack on Titan</button>
                <button class="btn-secondary" @click="searchQuery = 'Breaking Bad'; search()">Breaking Bad</button>
            </div>
        </div>
        
    </main>
    
    <!-- Media Modal -->
    <div x-show="showMediaModal" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm"
         @click.self="showMediaModal = false">
        
        <div x-show="showMediaModal"
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 scale-95"
             x-transition:enter-end="opacity-100 scale-100"
             class="glass-card rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            
            <template x-if="selectedMedia">
                <div class="relative">
                    <!-- Backdrop -->
                    <div class="absolute inset-0 h-64 overflow-hidden rounded-t-2xl">
                        <img :src="selectedMedia.backdrop_url || selectedMedia.poster_url" 
                             class="w-full h-full object-cover">
                        <div class="absolute inset-0 bg-gradient-to-t from-slate-900 via-slate-900/50 to-transparent"></div>
                    </div>
                    
                    <!-- Content -->
                    <div class="relative pt-40 p-8">
                        <div class="flex gap-8">
                            <!-- Poster -->
                            <div class="flex-shrink-0 w-48">
                                <img :src="selectedMedia.poster_url" class="w-full rounded-xl shadow-2xl">
                            </div>
                            
                            <!-- Info -->
                            <div class="flex-1">
                                <h2 class="text-3xl font-bold text-white mb-2" x-text="selectedMedia.title"></h2>
                                <div class="flex items-center gap-3 text-slate-300 mb-4">
                                    <span x-text="selectedMedia.year || '‚Äî'"></span>
                                    <span>‚Ä¢</span>
                                    <span x-text="getMediaTypeLabel(selectedMedia.media_type)"></span>
                                    <template x-if="selectedMedia.rating">
                                        <span class="flex items-center gap-1">
                                            <span>‚Ä¢</span>
                                            ‚≠ê <span x-text="selectedMedia.rating?.toFixed(1)"></span>
                                        </span>
                                    </template>
                                </div>
                                
                                <!-- Genres -->
                                <div x-show="selectedMedia.genres?.length" class="flex flex-wrap gap-2 mb-4">
                                    <template x-for="genre in selectedMedia.genres" :key="genre">
                                        <span class="px-3 py-1 bg-white/10 rounded-full text-sm text-slate-300" x-text="genre"></span>
                                    </template>
                                </div>
                                
                                <!-- Overview -->
                                <p class="text-slate-300 line-clamp-4 mb-6" x-text="selectedMedia.overview"></p>
                                
                                <!-- Actions -->
                                <div class="flex gap-4">
                                    <template x-if="!selectedMedia.already_available && user">
                                        <button @click="requestMedia()" 
                                                :disabled="requestingMedia"
                                                class="btn-primary">
                                            <span x-show="!requestingMedia">üì• Demander</span>
                                            <span x-show="requestingMedia">Envoi...</span>
                                        </button>
                                    </template>
                                    <template x-if="selectedMedia.already_available">
                                        <button class="btn-success" disabled>
                                            ‚úì D√©j√† disponible
                                        </button>
                                    </template>
                                    <template x-if="!user">
                                        <button @click="showMediaModal = false; showLoginModal = true" class="btn-primary">
                                            Connexion requise
                                        </button>
                                    </template>
                                    <button @click="showMediaModal = false" class="btn-secondary">
                                        Fermer
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </div>
    
    <!-- Login Modal -->
    <div x-show="showLoginModal" 
         x-transition
         class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm"
         @click.self="showLoginModal = false">
        
        <div class="glass-card rounded-2xl w-full max-w-md p-8">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Connexion</h2>
            
            <!-- Tabs -->
            <div class="flex gap-2 p-1 bg-white/5 rounded-xl mb-6">
                <button @click="loginTab = 'local'" 
                        :class="loginTab === 'local' ? 'bg-amber-500 text-white' : 'text-slate-400'"
                        class="flex-1 py-2 rounded-lg font-medium transition-all">
                    Compte local
                </button>
                <button @click="loginTab = 'plex'" 
                        :class="loginTab === 'plex' ? 'bg-amber-500 text-white' : 'text-slate-400'"
                        class="flex-1 py-2 rounded-lg font-medium transition-all">
                    Plex
                </button>
            </div>
            
            <!-- Local Login Form -->
            <form x-show="loginTab === 'local'" @submit.prevent="login()">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-1">Nom d'utilisateur</label>
                        <input type="text" x-model="loginForm.username" required
                               class="w-full px-4 py-2.5 bg-white/5 border border-white/10 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-amber-500/50">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-1">Mot de passe</label>
                        <input type="password" x-model="loginForm.password" required
                               class="w-full px-4 py-2.5 bg-white/5 border border-white/10 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-amber-500/50">
                    </div>
                    <div x-show="loginError" class="text-red-400 text-sm" x-text="loginError"></div>
                    <button type="submit" class="w-full btn-primary" :disabled="loggingIn">
                        <span x-show="!loggingIn">Se connecter</span>
                        <span x-show="loggingIn">Connexion...</span>
                    </button>
                </div>
            </form>
            
            <!-- Plex Login -->
            <div x-show="loginTab === 'plex'" class="text-center">
                <p class="text-slate-400 mb-6">Connectez-vous avec votre compte Plex</p>
                <button @click="loginWithPlex()" class="btn-plex w-full">
                    <svg class="w-5 h-5 mr-2" viewBox="0 0 1024 1024" fill="currentColor">
                        <path d="M512 0C229.23 0 0 229.23 0 512s229.23 512 512 512 512-229.23 512-512S794.77 0 512 0zm0 853.33c-188.52 0-341.33-152.81-341.33-341.33S323.48 170.67 512 170.67 853.33 323.48 853.33 512 700.52 853.33 512 853.33z"/>
                    </svg>
                    Connexion Plex
                </button>
            </div>
            
            <!-- Register Link -->
            <div class="mt-6 text-center text-slate-400">
                Pas de compte ? 
                <button @click="showLoginModal = false; showRegisterModal = true" class="text-amber-400 hover:underline">
                    S'inscrire
                </button>
            </div>
        </div>
    </div>
    
    <!-- Toast Notifications -->
    <div x-show="toast.show" 
         x-transition
         :class="toast.type === 'success' ? 'bg-green-500' : toast.type === 'error' ? 'bg-red-500' : 'bg-amber-500'"
         class="fixed bottom-6 right-6 px-6 py-3 rounded-xl text-white font-medium shadow-xl z-50">
        <span x-text="toast.message"></span>
    </div>
    
    <!-- App Script -->
    <script src="/static/js/app.js"></script>
</body>
</html>
